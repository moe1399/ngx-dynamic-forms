<div class="form-builder">
  <!-- Message Alert -->
  @if (message()) {
    <div class="alert" [class.alert-success]="message()!.type === 'success'" [class.alert-error]="message()!.type === 'error'">
      {{ message()!.text }}
    </div>
  }

  <!-- Toolbar -->
  @if (showToolbar()) {
    <div class="toolbar">
      @if (isToolbarButtonVisible('showNewForm') && !readOnly()) {
        <button class="btn btn-primary" (click)="createNewForm()">New Form</button>
      }
      @if (isToolbarButtonVisible('showSave') && !readOnly()) {
        <button class="btn btn-secondary" (click)="saveConfiguration()">Save</button>
      }
      @if (isToolbarButtonVisible('showExport')) {
        <button class="btn btn-secondary" (click)="exportJson()">Export JSON</button>
      }
      @if (isToolbarButtonVisible('showImport') && !readOnly()) {
        <button class="btn btn-secondary" (click)="openImportJson()">Import JSON</button>
      }
      @if (isToolbarButtonVisible('showEditJson') && !readOnly()) {
        <button class="btn btn-secondary" (click)="openEditJson()">Edit JSON</button>
      }
      @if (isToolbarButtonVisible('showShare')) {
        <button
          class="btn btn-share"
          (click)="shareRequested.emit()"
          [disabled]="currentConfig().fields.length === 0"
          title="Copy shareable URL to clipboard">
          Share
        </button>
      }
      @if (showVersionHistory() && currentConfig().id && !readOnly()) {
        <button
          class="btn btn-secondary btn-version"
          (click)="openCreateVersionModal()"
          title="Create a named version of the current form">
          Create Version
        </button>
      }
    </div>
  }

  <div class="builder-layout">
    <!-- Left Panel: Form Settings & Fields List -->
    <div class="left-panel">
      <!-- Form Settings -->
      @if (showFormSettings()) {
        <div class="panel-section">
          <h3>Form Settings</h3>
          <div class="form-group">
            <label>Form ID</label>
            <input
              type="text"
              [ngModel]="currentConfig().id"
              (ngModelChange)="updateFormSettings({ id: $event })"
              placeholder="form-id"
              [disabled]="readOnly()"
            />
          </div>
        </div>
      }

      <!-- Sections List -->
      <div class="panel-section">
        <h3>Sections</h3>
        @if (!readOnly()) {
          <button class="btn btn-sm btn-primary" (click)="addSection()">+ Add Section</button>
        }
        <div class="sections-list">
          @for (section of getSortedSections(); track section.id) {
            <div
              class="section-item"
              [class.selected]="selectedSectionId() === section.id"
              (click)="selectSection(section.id)">
              <div class="section-info">
                <strong>{{ section.id }}</strong>
              </div>
              @if (!readOnly()) {
                <div class="section-actions">
                  <button class="btn-icon" (click)="moveSectionUp(section.id); $event.stopPropagation()" title="Move Up">↑</button>
                  <button class="btn-icon" (click)="moveSectionDown(section.id); $event.stopPropagation()" title="Move Down">↓</button>
                  <button class="btn-icon btn-danger" (click)="removeSection(section.id); $event.stopPropagation()" title="Delete">×</button>
                </div>
              }
            </div>
          }
          @if (getSortedSections().length === 0) {
            <p class="empty-state">No sections. Fields will render ungrouped.</p>
          }
        </div>
      </div>

      <!-- Wizard Mode -->
      <div class="panel-section">
        <h3>Wizard Mode</h3>
        <div class="form-group">
          <label class="checkbox-label">
            <input
              type="checkbox"
              [checked]="isWizardModeEnabled()"
              (change)="toggleWizardMode($event)"
              [disabled]="readOnly()">
            Enable Wizard Mode
          </label>
          <small class="form-hint">Split form into multiple pages with step navigation</small>
        </div>

        @if (isWizardModeEnabled()) {
          <div class="wizard-settings">
            <div class="form-group">
              <label class="checkbox-label">
                <input
                  type="checkbox"
                  [checked]="currentConfig().wizard?.allowFreeNavigation || false"
                  (change)="updateWizardAllowFreeNavigation($event)"
                  [disabled]="readOnly()">
                Allow Free Navigation
              </label>
              <small class="form-hint">Users can click any step without validation</small>
            </div>

            <div class="form-group">
              <label class="checkbox-label">
                <input
                  type="checkbox"
                  [checked]="currentConfig().wizard?.showProgressBar !== false"
                  (change)="updateWizardShowProgressBar($event)"
                  [disabled]="readOnly()">
                Show Progress Bar
              </label>
            </div>

            <div class="form-group">
              <label class="checkbox-label">
                <input
                  type="checkbox"
                  [checked]="currentConfig().wizard?.showPageNumbers !== false"
                  (change)="updateWizardShowPageNumbers($event)"
                  [disabled]="readOnly()">
                Show Page Numbers
              </label>
            </div>

            <div class="form-group">
              <label>Next Button Label</label>
              <input
                type="text"
                [ngModel]="currentConfig().wizard?.nextLabel || ''"
                (ngModelChange)="updateWizardNextLabel($event)"
                placeholder="Next"
                [disabled]="readOnly()">
            </div>

            <div class="form-group">
              <label>Previous Button Label</label>
              <input
                type="text"
                [ngModel]="currentConfig().wizard?.prevLabel || ''"
                (ngModelChange)="updateWizardPrevLabel($event)"
                placeholder="Previous"
                [disabled]="readOnly()">
            </div>

            <div class="form-group">
              <label>Submit Button Label</label>
              <input
                type="text"
                [ngModel]="currentConfig().wizard?.submitLabel || ''"
                (ngModelChange)="updateWizardSubmitLabel($event)"
                placeholder="Submit"
                [disabled]="readOnly()">
            </div>
          </div>

          <!-- Wizard Pages List -->
          <div class="wizard-pages">
            <h4>Wizard Pages</h4>
            @if (!readOnly()) {
              <button class="btn btn-sm btn-primary" (click)="addWizardPage()">+ Add Page</button>
            }

            @for (page of getWizardPages(); track page.id) {
              <div
                class="wizard-page-item"
                [class.selected]="selectedWizardPageId() === page.id"
                (click)="selectWizardPage(page.id)">
                <div class="page-info">
                  <strong>{{ page.title }}</strong>
                  <small>{{ page.sectionIds.length }} sections</small>
                </div>
                @if (!readOnly()) {
                  <div class="page-actions">
                    <button class="btn-icon" (click)="moveWizardPageUp(page.id); $event.stopPropagation()" title="Move Up">↑</button>
                    <button class="btn-icon" (click)="moveWizardPageDown(page.id); $event.stopPropagation()" title="Move Down">↓</button>
                    <button class="btn-icon btn-danger" (click)="removeWizardPage(page.id); $event.stopPropagation()" title="Delete">×</button>
                  </div>
                }
              </div>
            }

            @if (getWizardPages().length === 0) {
              <p class="empty-state">No pages. Add pages and assign sections to them.</p>
            }

            @if (getUnassignedSections().length > 0) {
              <div class="warning-message">
                <strong>Warning:</strong> {{ getUnassignedSections().length }} section(s) not assigned to any page
              </div>
            }
          </div>
        }
      </div>

      <!-- Version History -->
      @if (showVersionHistory()) {
        <div class="panel-section version-history-section">
          <h3 (click)="toggleHistoryPanel()">
            Version History
            <span class="toggle-indicator">{{ historyPanelOpen() ? '▼' : '▶' }}</span>
          </h3>

          @if (historyPanelOpen()) {
            <div class="version-history-content">
              @if (versions().length === 0) {
                <p class="empty-state">No version history yet. Versions are created automatically when you save.</p>
              } @else {
                <div class="version-list">
                  @for (version of versions(); track version.id) {
                    <div
                      class="version-item"
                      [class.selected]="selectedVersionId() === version.id"
                      [attr.data-version-id]="version.id"
                      [attr.data-current-version]="isLatestVersion(version.id) ? '' : null">
                      <div class="version-header">
                        <span class="version-number">{{ getVersionLabel(version) }}</span>
                        <span class="version-date">{{ formatVersionTimestamp(version.timestamp) }}</span>
                      </div>
                      @if (version.description) {
                        <div class="version-description">{{ version.description }}</div>
                      }
                      <div class="version-actions">
                        <button
                          class="btn-sm btn-secondary"
                          (click)="previewVersion(version.id); $event.stopPropagation()"
                          title="Preview this version">
                          Preview
                        </button>
                        @if (!isLatestVersion(version.id) && !readOnly()) {
                          <button
                            class="btn-sm btn-primary"
                            (click)="restoreVersion(version.id); $event.stopPropagation()"
                            title="Restore this version">
                            Restore
                          </button>
                        }
                      </div>
                    </div>
                  }
                </div>
              }
            </div>
          }
        </div>
      }

      <!-- Fields List -->
      <div class="panel-section">
        <h3>Fields</h3>
        @if (!readOnly()) {
          <button class="btn btn-sm btn-primary" (click)="addField()">+ Add Field</button>
        }
        <div class="fields-list">
          @for (field of currentConfig().fields; track field.name; let i = $index) {
            <div
              class="field-item"
              [class.selected]="selectedFieldIndex() === i"
              (click)="selectField(i)">
              <div class="field-info">
                <strong>{{ field.name }}</strong>
                <small>({{ field.type }})</small>
              </div>
              @if (!readOnly()) {
                <div class="field-actions">
                  <button class="btn-icon" (click)="moveFieldUp(i); $event.stopPropagation()" title="Move Up">↑</button>
                  <button class="btn-icon" (click)="moveFieldDown(i); $event.stopPropagation()" title="Move Down">↓</button>
                  <button class="btn-icon btn-danger" (click)="removeField(i); $event.stopPropagation()" title="Delete">×</button>
                </div>
              }
            </div>
          }
        </div>
      </div>

      <!-- Saved Configurations -->
      @if (showSavedConfigs()) {
        <div class="panel-section">
          <h3>Saved Forms</h3>
          @if (savedConfigs().length === 0) {
            <p class="empty-state">No saved forms</p>
          }
          @for (config of savedConfigs(); track config.id) {
            <div class="saved-config-item">
              <span class="config-name">{{ config.id }}</span>
              <div class="config-actions">
                <button class="btn-sm btn-secondary" (click)="loadConfiguration(config.id)">Load</button>
                @if (!readOnly()) {
                  <button class="btn-sm btn-danger" (click)="deleteConfiguration(config.id)">Delete</button>
                }
              </div>
            </div>
          }
        </div>
      }
    </div>

    <!-- Right Panel: Field/Section Editor -->
    <div class="right-panel">
      <!-- Version Preview Banner -->
      @if (versionPreviewMode() && previewedVersionConfig()) {
        <div class="version-preview-banner" data-preview-mode>
          <div class="preview-info">
            <strong>Previewing Version</strong>
            @if (getSelectedVersion(); as previewVersion) {
              <span>{{ getVersionLabel(previewVersion) }} - {{ formatVersionTimestamp(previewVersion.timestamp) }}</span>
            }
          </div>
          <div class="preview-actions">
            @if (!readOnly()) {
              <button class="btn-sm btn-primary" (click)="restoreVersion(selectedVersionId()!)">
                Restore This Version
              </button>
            }
            <button class="btn-sm btn-secondary" (click)="exitPreviewMode()">
              Exit Preview
            </button>
          </div>
        </div>

        <!-- Version Preview Content -->
        <div class="version-preview-content">
          <div class="preview-section">
            <h4>Form Settings</h4>
            <div class="preview-item">
              <span class="preview-label">Form ID:</span>
              <span class="preview-value">{{ previewedVersionConfig()!.id }}</span>
            </div>
          </div>

          @if (previewedVersionConfig()!.sections?.length) {
            <div class="preview-section">
              <h4>Sections ({{ previewedVersionConfig()!.sections!.length }})</h4>
              @for (section of previewedVersionConfig()!.sections; track section.id) {
                <div class="preview-item-block">
                  <div class="preview-item">
                    <span class="preview-label">ID:</span>
                    <span class="preview-value">{{ section.id }}</span>
                  </div>
                  <div class="preview-item">
                    <span class="preview-label">Title:</span>
                    <span class="preview-value">{{ section.title }}</span>
                  </div>
                  @if (section.description) {
                    <div class="preview-item">
                      <span class="preview-label">Description:</span>
                      <span class="preview-value">{{ section.description }}</span>
                    </div>
                  }
                </div>
              }
            </div>
          }

          @if (previewedVersionConfig()!.wizard) {
            <div class="preview-section">
              <h4>Wizard Pages ({{ previewedVersionConfig()!.wizard!.pages.length }})</h4>
              @for (page of previewedVersionConfig()!.wizard!.pages; track page.id) {
                <div class="preview-item-block">
                  <div class="preview-item">
                    <span class="preview-label">Title:</span>
                    <span class="preview-value">{{ page.title }}</span>
                  </div>
                  <div class="preview-item">
                    <span class="preview-label">Sections:</span>
                    <span class="preview-value">{{ page.sectionIds.join(', ') }}</span>
                  </div>
                </div>
              }
            </div>
          }

          <div class="preview-section">
            <h4>Fields ({{ previewedVersionConfig()!.fields.length }})</h4>
            @for (field of previewedVersionConfig()!.fields; track field.name) {
              <div class="preview-item-block">
                <div class="preview-item">
                  <span class="preview-label">Name:</span>
                  <span class="preview-value">{{ field.name }}</span>
                </div>
                <div class="preview-item">
                  <span class="preview-label">Type:</span>
                  <span class="preview-value">{{ field.type }}</span>
                </div>
                <div class="preview-item">
                  <span class="preview-label">Label:</span>
                  <span class="preview-value">{{ field.label }}</span>
                </div>
                @if (field.sectionId) {
                  <div class="preview-item">
                    <span class="preview-label">Section:</span>
                    <span class="preview-value">{{ field.sectionId }}</span>
                  </div>
                }
                @if (field.validations?.length) {
                  <div class="preview-item">
                    <span class="preview-label">Validations:</span>
                    <span class="preview-value">{{ getFieldValidationSummary(field) }}</span>
                  </div>
                }
              </div>
            }
          </div>
        </div>
      }

      <!-- Section Editor (hidden in preview mode) -->
      @if (!versionPreviewMode()) {
      @if (selectedSectionId() !== null && getSelectedSection()) {
        <div class="section-editor">
          <h3>Edit Section</h3>
          @let section = getSelectedSection()!;

          <div class="form-group">
            <label>Section ID</label>
            <input
              type="text"
              [ngModel]="section.id"
              (ngModelChange)="updateSectionId(section.id, $event)"
              #sectionIdInput="ngModel"
              [disabled]="readOnly()"
            />
            @if (sectionIdInput.value && isSectionIdDuplicate(sectionIdInput.value, section.id)) {
              <small class="form-error">Section ID already exists</small>
            } @else {
              <small class="form-hint">Unique identifier for the section</small>
            }
          </div>

          <div class="form-group">
            <label>Title</label>
            <input
              type="text"
              [ngModel]="section.title"
              (ngModelChange)="updateSectionTitle(section.id, $event)"
              [disabled]="readOnly()"
            />
          </div>

          <div class="form-group">
            <label>Description (optional)</label>
            <textarea
              rows="3"
              [ngModel]="section.description"
              (ngModelChange)="updateSectionDescription(section.id, $event)"
              placeholder="Description text appears below the section header"
              [disabled]="readOnly()"
            ></textarea>
          </div>

          <div class="form-group">
            <label>Anchor ID (optional)</label>
            <input
              type="text"
              [ngModel]="section.anchorId"
              (ngModelChange)="updateSectionAnchorId(section.id, $event)"
              placeholder="Leave empty to auto-generate from title"
              [disabled]="readOnly()"
            />
            <small class="form-hint">Custom anchor for navigation links (e.g., #school-info)</small>
          </div>

          <!-- Section Visibility Condition -->
          <div class="condition-section">
            <h4>Visibility Condition</h4>
            <div class="form-group condition-toggle">
              <label>
                <input
                  type="checkbox"
                  [checked]="!!section.condition"
                  (change)="toggleSectionCondition(section.id)"
                  [disabled]="readOnly()"
                />
                Show conditionally
              </label>
            </div>

            @if (section.condition) {
              <div class="condition-config">
                <div class="form-group">
                  <label>When field</label>
                  <select
                    [ngModel]="section.condition.field"
                    (ngModelChange)="updateSectionConditionField(section.id, $event)"
                    [disabled]="readOnly()">
                    @for (f of getAvailableSectionConditionFields(); track f.value) {
                      <option [value]="f.value">{{ f.label }}</option>
                    }
                  </select>
                </div>

                <div class="form-group">
                  <label>Operator</label>
                  <select
                    [ngModel]="section.condition.operator"
                    (ngModelChange)="updateSectionConditionOperator(section.id, $event)"
                    [disabled]="readOnly()">
                    @for (op of conditionOperators; track op) {
                      <option [value]="op">{{ op }}</option>
                    }
                  </select>
                </div>

                @if (section.condition.operator === 'equals' || section.condition.operator === 'notEquals') {
                  <div class="form-group">
                    <label>Value</label>
                    <input
                      type="text"
                      [ngModel]="section.condition.value"
                      (ngModelChange)="updateSectionConditionValue(section.id, $event)"
                      placeholder="Enter value"
                      [disabled]="readOnly()"
                    />
                  </div>
                }
              </div>
            }
          </div>
        </div>
      }
      <!-- Wizard Page Editor -->
      @else if (selectedWizardPageId() !== null && getSelectedWizardPage()) {
        <div class="wizard-page-editor">
          <h3>Edit Wizard Page</h3>
          @let page = getSelectedWizardPage()!;

          <div class="form-group">
            <label>Page ID</label>
            <input
              type="text"
              [ngModel]="page.id"
              (ngModelChange)="updateWizardPageId(page.id, $event)"
              [disabled]="readOnly()"
            />
            <small class="form-hint">Unique identifier for the page</small>
          </div>

          <div class="form-group">
            <label>Page Title</label>
            <input
              type="text"
              [ngModel]="page.title"
              (ngModelChange)="updateWizardPageTitle(page.id, $event)"
              [disabled]="readOnly()"
            />
            <small class="form-hint">Shown in the progress bar</small>
          </div>

          <div class="form-group">
            <label>Page Description (optional)</label>
            <textarea
              rows="3"
              [ngModel]="page.description"
              (ngModelChange)="updateWizardPageDescription(page.id, $event)"
              placeholder="Description shown at the top of the page"
              [disabled]="readOnly()"
            ></textarea>
          </div>

          <!-- Section Assignment -->
          <div class="form-group">
            <label>Sections on This Page</label>
            <div class="section-checkboxes">
              @for (section of getSortedSections(); track section.id) {
                <label class="checkbox-label">
                  <input
                    type="checkbox"
                    [checked]="isSectionInPage(page.id, section.id)"
                    (change)="toggleSectionInPage(page.id, section.id)"
                    [disabled]="readOnly()">
                  {{ section.title }}
                </label>
              }
              @if (getSortedSections().length === 0) {
                <p class="empty-state">No sections defined. Create sections first.</p>
              }
            </div>
            <small class="form-hint">Select which sections appear on this page</small>
          </div>

          <!-- Page Visibility Condition -->
          <div class="condition-section">
            <h4>Visibility Condition</h4>
            <div class="form-group condition-toggle">
              <label>
                <input
                  type="checkbox"
                  [checked]="!!page.condition"
                  (change)="toggleWizardPageCondition(page.id)"
                  [disabled]="readOnly()"
                />
                Show conditionally
              </label>
            </div>

            @if (page.condition) {
              <div class="condition-config">
                <div class="form-group">
                  <label>When field</label>
                  <select
                    [ngModel]="page.condition.field"
                    (ngModelChange)="updateWizardPageConditionField(page.id, $event)"
                    [disabled]="readOnly()">
                    @for (f of getAvailableSectionConditionFields(); track f.value) {
                      <option [value]="f.value">{{ f.label }}</option>
                    }
                  </select>
                </div>

                <div class="form-group">
                  <label>Operator</label>
                  <select
                    [ngModel]="page.condition.operator"
                    (ngModelChange)="updateWizardPageConditionOperator(page.id, $event)"
                    [disabled]="readOnly()">
                    @for (op of conditionOperators; track op) {
                      <option [value]="op">{{ op }}</option>
                    }
                  </select>
                </div>

                @if (page.condition.operator === 'equals' || page.condition.operator === 'notEquals') {
                  <div class="form-group">
                    <label>Value</label>
                    <input
                      type="text"
                      [ngModel]="page.condition.value"
                      (ngModelChange)="updateWizardPageConditionValue(page.id, $event)"
                      placeholder="Enter value"
                      [disabled]="readOnly()"
                    />
                  </div>
                }
              </div>
            }
          </div>
        </div>
      }
      <!-- Field Editor -->
      @else if (selectedFieldIndex() !== null && getSelectedField()) {
        <div class="field-editor">
          <h3>Edit Field</h3>
          @let field = getSelectedField()!;
          @let fieldIndex = selectedFieldIndex()!;

          <div class="form-group">
            <label>Field Name (ID)</label>
            <input
              type="text"
              [ngModel]="field.name"
              (ngModelChange)="updateFieldName(fieldIndex, $event)"
              [disabled]="readOnly()"
            />
          </div>

          <div class="form-group">
            <label>Label</label>
            <input
              type="text"
              [ngModel]="field.label"
              (ngModelChange)="updateFieldLabel(fieldIndex, $event)"
              [disabled]="readOnly()"
            />
          </div>

          <div class="form-group">
            <label>Field Type</label>
            <select
              [ngModel]="field.type"
              (ngModelChange)="updateFieldType(fieldIndex, $event)"
              [disabled]="readOnly()">
              @for (type of fieldTypes; track type) {
                <option [value]="type">{{ type }}</option>
              }
            </select>
          </div>

          <!-- Info block content (only for info type) -->
          @if (field.type === 'info') {
            <div class="form-group">
              <label>Content (Markdown supported)</label>
              <textarea
                rows="6"
                [ngModel]="field.content"
                (ngModelChange)="updateFieldContent(fieldIndex, $event)"
                placeholder="Enter information text. Supports **bold**, *italic*, and [links](url)"
                [disabled]="readOnly()"
              ></textarea>
              <small class="form-hint">Supports: **bold**, *italic*, [link text](url), line breaks</small>
            </div>
          }

          <!-- Placeholder (not for info type) -->
          @if (field.type !== 'info') {
            <div class="form-group">
              <label>Placeholder</label>
              <input
                type="text"
                [ngModel]="field.placeholder"
                (ngModelChange)="updateFieldPlaceholder(fieldIndex, $event)"
                [disabled]="readOnly()"
              />
            </div>

            <div class="form-group">
              <label>Description (help text)</label>
              <textarea
                rows="2"
                [ngModel]="field.description"
                (ngModelChange)="updateFieldDescription(fieldIndex, $event)"
                placeholder="Optional help text shown via info icon"
                [disabled]="readOnly()"
              ></textarea>
            </div>
          }

          <!-- Inline Group Settings -->
          <div class="form-group">
            <label>Inline Group</label>
            <input
              type="text"
              [ngModel]="field.inlineGroup"
              (ngModelChange)="updateFieldInlineGroup(fieldIndex, $event)"
              placeholder="e.g. name-row, address-row"
              [disabled]="readOnly()"
            />
            <small class="form-hint">Fields with the same group name appear on the same row</small>
          </div>

          <div class="form-group">
            <label>Width (1-4)</label>
            <select
              [ngModel]="field.width || 1"
              (ngModelChange)="updateFieldWidth(fieldIndex, $event)"
              [disabled]="readOnly()">
              <option [value]="1">1 (default)</option>
              <option [value]="2">2 (double)</option>
              <option [value]="3">3 (triple)</option>
              <option [value]="4">4 (quadruple)</option>
            </select>
            <small class="form-hint">Relative width within inline group</small>
          </div>

          <!-- Section Assignment -->
          <div class="form-group">
            <label>Section</label>
            <select
              [ngModel]="field.sectionId || ''"
              (ngModelChange)="updateFieldSectionId(fieldIndex, $event)"
              [disabled]="readOnly()">
              <option value="">-- No Section --</option>
              @for (section of getSortedSections(); track section.id) {
                <option [value]="section.id">{{ section.title }}</option>
              }
            </select>
            <small class="form-hint">Assign field to a section</small>
          </div>

          <div class="form-group">
            <label>
              <input
                type="checkbox"
                [ngModel]="field.disabled"
                (ngModelChange)="updateFieldDisabled(fieldIndex, $event)"
                [disabled]="readOnly()"
              />
              Disabled
            </label>
          </div>

          <!-- Field Visibility Condition -->
          <div class="condition-section">
            <h4>Visibility Condition</h4>
            <div class="form-group condition-toggle">
              <label>
                <input
                  type="checkbox"
                  [checked]="!!field.condition"
                  (change)="toggleFieldCondition(fieldIndex)"
                  [disabled]="readOnly()"
                />
                Show conditionally
              </label>
            </div>

            @if (field.condition) {
              <div class="condition-config">
                <div class="form-group">
                  <label>When field</label>
                  <select
                    [ngModel]="field.condition.field"
                    (ngModelChange)="updateFieldConditionField(fieldIndex, $event)"
                    [disabled]="readOnly()">
                    @for (f of getAvailableFieldConditionFields(fieldIndex); track f.value) {
                      <option [value]="f.value">{{ f.label }}</option>
                    }
                  </select>
                </div>

                <div class="form-group">
                  <label>Operator</label>
                  <select
                    [ngModel]="field.condition.operator"
                    (ngModelChange)="updateFieldConditionOperator(fieldIndex, $event)"
                    [disabled]="readOnly()">
                    @for (op of conditionOperators; track op) {
                      <option [value]="op">{{ op }}</option>
                    }
                  </select>
                </div>

                @if (field.condition.operator === 'equals' || field.condition.operator === 'notEquals') {
                  <div class="form-group">
                    <label>Value</label>
                    <input
                      type="text"
                      [ngModel]="field.condition.value"
                      (ngModelChange)="updateFieldConditionValue(fieldIndex, $event)"
                      placeholder="Enter value"
                      [disabled]="readOnly()"
                    />
                  </div>
                }
              </div>
            }
          </div>

          <!-- Options (for select, radio, checkbox fields) -->
          @if (field.type === 'select' || field.type === 'radio' || field.type === 'checkbox') {
            <div class="options-section">
              <h4>Options</h4>
              @if (field.type === 'radio') {
                <small class="form-hint">Radio buttons allow single selection (mutually exclusive)</small>
              }
              @if (field.type === 'checkbox') {
                <small class="form-hint">Checkboxes allow multiple selections</small>
              }
              @if (!readOnly()) {
                <button class="btn-sm btn-primary" (click)="addOption(fieldIndex)">+ Add Option</button>
              }

              @for (option of field.options; track $index; let oi = $index) {
                <div class="option-item">
                  <div class="form-group">
                    <label>Label</label>
                    <input
                      type="text"
                      [ngModel]="option.label"
                      (ngModelChange)="updateOptionLabel(fieldIndex, oi, $event)"
                      placeholder="Display text"
                      [disabled]="readOnly()"
                    />
                  </div>
                  <div class="form-group">
                    <label>Value</label>
                    <input
                      type="text"
                      [ngModel]="option.value"
                      (ngModelChange)="updateOptionValue(fieldIndex, oi, $event)"
                      placeholder="Stored value"
                      [disabled]="readOnly()"
                    />
                  </div>
                  @if (!readOnly()) {
                    <button class="btn-sm btn-danger" (click)="removeOption(fieldIndex, oi)">Remove</button>
                  }
                </div>
              }

              @if (!field.options || field.options.length === 0) {
                <p class="empty-state">No options. Add at least one option.</p>
              }
            </div>
          }

          <!-- Table Configuration (for table fields) -->
          @if (field.type === 'table') {
            <div class="table-config-section">
              <h4>Table Configuration</h4>

              <!-- Row Mode -->
              <div class="form-group">
                <label>Row Mode</label>
                <select
                  [ngModel]="field.tableConfig?.rowMode || 'fixed'"
                  (ngModelChange)="updateTableRowMode(fieldIndex, $event)"
                  [disabled]="readOnly()">
                  <option value="fixed">Fixed (set number of rows)</option>
                  <option value="dynamic">Dynamic (add/remove rows)</option>
                </select>
              </div>

              <!-- Fixed Mode Settings -->
              @if (field.tableConfig?.rowMode === 'fixed') {
                <div class="form-group">
                  <label>Number of Rows</label>
                  <input
                    type="number"
                    min="1"
                    max="20"
                    [ngModel]="field.tableConfig?.fixedRowCount || 3"
                    (ngModelChange)="updateTableFixedRowCount(fieldIndex, $event)"
                    [disabled]="readOnly()"
                  />
                </div>
              }

              <!-- Dynamic Mode Settings -->
              @if (field.tableConfig?.rowMode === 'dynamic') {
                <div class="form-group">
                  <label>Minimum Rows</label>
                  <input
                    type="number"
                    min="0"
                    max="10"
                    [ngModel]="field.tableConfig?.minRows || 0"
                    (ngModelChange)="updateTableMinRows(fieldIndex, $event)"
                    [disabled]="readOnly()"
                  />
                </div>
                <div class="form-group">
                  <label>Maximum Rows</label>
                  <input
                    type="number"
                    min="1"
                    max="50"
                    [ngModel]="field.tableConfig?.maxRows || 10"
                    (ngModelChange)="updateTableMaxRows(fieldIndex, $event)"
                    [disabled]="readOnly()"
                  />
                </div>
                <div class="form-group">
                  <label>Add Row Button Text</label>
                  <input
                    type="text"
                    [ngModel]="field.tableConfig?.addRowLabel || ''"
                    (ngModelChange)="updateTableAddRowLabel(fieldIndex, $event)"
                    placeholder="Add row"
                    [disabled]="readOnly()"
                  />
                </div>
              }

              <!-- Columns -->
              <div class="columns-section">
                <h5>Columns</h5>
                <button class="btn-sm btn-primary" (click)="addTableColumn(fieldIndex)">+ Add Column</button>

                @for (column of field.tableConfig?.columns; track $index; let ci = $index) {
                  <div class="column-item">
                    <div class="column-header">
                      <strong>{{ column.label }}</strong>
                      <div class="column-actions">
                        <button class="btn-icon" (click)="moveTableColumnUp(fieldIndex, ci)" title="Move Left">←</button>
                        <button class="btn-icon" (click)="moveTableColumnDown(fieldIndex, ci)" title="Move Right">→</button>
                        <button
                          class="btn-icon btn-danger"
                          (click)="removeTableColumn(fieldIndex, ci)"
                          [disabled]="field.tableConfig?.columns?.length === 1"
                          title="Delete">×</button>
                      </div>
                    </div>

                    <div class="form-group">
                      <label>Column Name (ID)</label>
                      <input
                        type="text"
                        [ngModel]="column.name"
                        (ngModelChange)="updateColumnName(fieldIndex, ci, $event)"
                      />
                    </div>

                    <div class="form-group">
                      <label>Column Label</label>
                      <input
                        type="text"
                        [ngModel]="column.label"
                        (ngModelChange)="updateColumnLabel(fieldIndex, ci, $event)"
                      />
                    </div>

                    <div class="form-group">
                      <label>Column Type</label>
                      <select
                        [ngModel]="column.type"
                        (ngModelChange)="updateColumnType(fieldIndex, ci, $event)">
                        @for (type of tableColumnTypes; track type) {
                          <option [value]="type">{{ type }}</option>
                        }
                      </select>
                    </div>

                    <div class="form-group">
                      <label>Placeholder</label>
                      <input
                        type="text"
                        [ngModel]="column.placeholder"
                        (ngModelChange)="updateColumnPlaceholder(fieldIndex, ci, $event)"
                      />
                    </div>

                    <div class="form-group">
                      <label>Width (1-4)</label>
                      <select
                        [ngModel]="column.width || 1"
                        (ngModelChange)="updateColumnWidth(fieldIndex, ci, $event)">
                        <option [value]="1">1 (default)</option>
                        <option [value]="2">2 (wider)</option>
                        <option [value]="3">3 (wide)</option>
                        <option [value]="4">4 (widest)</option>
                      </select>
                    </div>

                    <!-- Column Options (for select type) -->
                    @if (column.type === 'select') {
                      <div class="column-options">
                        <label>Options</label>
                        <button class="btn-sm btn-secondary" (click)="addColumnOption(fieldIndex, ci)">+ Add Option</button>

                        @for (option of column.options; track $index; let oi = $index) {
                          <div class="option-row">
                            <input
                              type="text"
                              [ngModel]="option.label"
                              (ngModelChange)="updateColumnOptionLabel(fieldIndex, ci, oi, $event)"
                              placeholder="Label"
                            />
                            <input
                              type="text"
                              [ngModel]="option.value"
                              (ngModelChange)="updateColumnOptionValue(fieldIndex, ci, oi, $event)"
                              placeholder="Value"
                            />
                            <button class="btn-icon btn-danger" (click)="removeColumnOption(fieldIndex, ci, oi)">×</button>
                          </div>
                        }
                      </div>
                    }

                    <!-- Column Validations -->
                    <div class="column-validations">
                      <label>Validations</label>
                      <button class="btn-sm btn-secondary" (click)="addColumnValidation(fieldIndex, ci)">+ Add Validation</button>

                      @for (validation of column.validations; track $index; let vi = $index) {
                        <div class="validation-row">
                          <select
                            [ngModel]="validation.type"
                            (ngModelChange)="updateColumnValidationType(fieldIndex, ci, vi, $event)">
                            @for (vType of validationTypes; track vType) {
                              <option [value]="vType">{{ vType }}</option>
                            }
                          </select>

                          @if (validation.type === 'minLength' || validation.type === 'maxLength' || validation.type === 'min' || validation.type === 'max') {
                            <input
                              type="number"
                              [ngModel]="validation.value"
                              (ngModelChange)="updateColumnValidationValue(fieldIndex, ci, vi, $event)"
                              placeholder="Value"
                            />
                          }

                          @if (validation.type === 'pattern') {
                            <input
                              type="text"
                              [ngModel]="validation.value"
                              (ngModelChange)="updateColumnValidationValue(fieldIndex, ci, vi, $event)"
                              placeholder="Regex pattern"
                            />
                          }

                          <input
                            type="text"
                            [ngModel]="validation.message"
                            (ngModelChange)="updateColumnValidationMessage(fieldIndex, ci, vi, $event)"
                            placeholder="Error message"
                          />

                          <button class="btn-icon btn-danger" (click)="removeColumnValidation(fieldIndex, ci, vi)">×</button>
                        </div>

                        <!-- Conditional Validation for Table Column -->
                        <div class="column-condition-section">
                          <label class="condition-toggle-inline">
                            <input
                              type="checkbox"
                              [checked]="!!validation.condition"
                              (change)="toggleColumnValidationCondition(fieldIndex, ci, vi)"
                            />
                            Conditional
                          </label>

                          @if (validation.condition) {
                            <div class="column-condition-config">
                              <select
                                [ngModel]="validation.condition.field"
                                (ngModelChange)="updateColumnValidationConditionField(fieldIndex, ci, vi, $event)">
                                @for (f of getAvailableColumnConditionFields(fieldIndex, ci, 'table'); track f.value) {
                                  <option [value]="f.value">{{ f.label }}</option>
                                }
                              </select>
                              <select
                                [ngModel]="validation.condition.operator"
                                (ngModelChange)="updateColumnValidationConditionOperator(fieldIndex, ci, vi, $event)">
                                @for (op of conditionOperators; track op) {
                                  <option [value]="op">{{ op }}</option>
                                }
                              </select>
                              @if (validation.condition.operator === 'equals' || validation.condition.operator === 'notEquals') {
                                <input
                                  type="text"
                                  [ngModel]="validation.condition.value"
                                  (ngModelChange)="updateColumnValidationConditionValue(fieldIndex, ci, vi, $event)"
                                  placeholder="Value"
                                />
                              }
                            </div>
                          }
                        </div>
                      }
                    </div>
                  </div>
                }
              </div>
            </div>
          }

          <!-- Date Range Configuration (for daterange fields) -->
          @if (field.type === 'daterange') {
            <div class="daterange-config-section">
              <h4>Date Range Configuration</h4>

              <div class="form-group">
                <label>From Date Label</label>
                <input
                  type="text"
                  [ngModel]="field.daterangeConfig?.fromLabel || ''"
                  (ngModelChange)="updateDateRangeFromLabel(fieldIndex, $event)"
                  placeholder="e.g., Start Date"
                />
                <small class="form-hint">Optional label shown above the from date input</small>
              </div>

              <div class="form-group">
                <label>To Date Label</label>
                <input
                  type="text"
                  [ngModel]="field.daterangeConfig?.toLabel || ''"
                  (ngModelChange)="updateDateRangeToLabel(fieldIndex, $event)"
                  placeholder="e.g., End Date"
                />
                <small class="form-hint">Optional label shown above the to date input</small>
              </div>

              <div class="form-group">
                <label>Separator Text</label>
                <input
                  type="text"
                  [ngModel]="field.daterangeConfig?.separatorText || 'to'"
                  (ngModelChange)="updateDateRangeSeparator(fieldIndex, $event)"
                  placeholder="to"
                />
                <small class="form-hint">Text displayed between the two date inputs</small>
              </div>

              <div class="form-group checkbox-group">
                <label>
                  <input
                    type="checkbox"
                    [ngModel]="field.daterangeConfig?.toDateOptional || false"
                    (ngModelChange)="updateDateRangeToDateOptional(fieldIndex, $event)"
                  />
                  To date is optional
                </label>
                <small class="form-hint">If checked, the "to date" can be empty even with required validation</small>
              </div>
            </div>
          }

          <!-- Form Reference Configuration (for formref fields) -->
          @if (field.type === 'formref') {
            <div class="formref-config-section">
              <h4>Form Reference Configuration</h4>
              <small class="form-hint">Embed fields from another saved form into this form</small>

              <div class="form-group">
                <label>Referenced Form</label>
                <select
                  [ngModel]="field.formrefConfig?.formId || ''"
                  (ngModelChange)="updateFormRefFormId(fieldIndex, $event)">
                  <option value="">-- Select a Form --</option>
                  @for (config of getAvailableFormsForFormRef(); track config.id) {
                    <option [value]="config.id">{{ config.id }}</option>
                  }
                </select>
                <small class="form-hint">Select the saved form to embed</small>
                @if (getAvailableFormsForFormRef().length === 0) {
                  <small class="form-hint" style="color: #c00;">No saved forms available. Save a form first to embed it.</small>
                }
              </div>

              <div class="form-group checkbox-group">
                <label>
                  <input
                    type="checkbox"
                    [ngModel]="field.formrefConfig?.showSections || false"
                    (ngModelChange)="updateFormRefShowSections(fieldIndex, $event)"
                  />
                  Show section headers from embedded form
                </label>
                <small class="form-hint">If checked, section headers from the referenced form will be displayed</small>
              </div>

              <div class="form-group">
                <label>Field Name Prefix (optional)</label>
                <input
                  type="text"
                  [ngModel]="field.formrefConfig?.fieldPrefix || ''"
                  (ngModelChange)="updateFormRefFieldPrefix(fieldIndex, $event)"
                  placeholder="e.g., contact_"
                />
                <small class="form-hint">Prefix added to embedded field names to avoid conflicts (e.g., contact_email)</small>
              </div>
            </div>
          }

          <!-- File Upload Configuration (for fileupload fields) -->
          @if (field.type === 'fileupload') {
            <div class="fileupload-config-section">
              <h4>File Upload Configuration</h4>
              <small class="form-hint">Configure file upload behavior and restrictions</small>

              <div class="form-group">
                <label>Maximum Files</label>
                <input
                  type="number"
                  min="1"
                  max="100"
                  [ngModel]="field.fileuploadConfig?.maxFiles || 1"
                  (ngModelChange)="updateFileUploadMaxFiles(fieldIndex, $event)"
                />
                <small class="form-hint">Maximum number of files that can be uploaded</small>
              </div>

              <div class="form-group">
                <label>Minimum Files</label>
                <input
                  type="number"
                  min="0"
                  max="100"
                  [ngModel]="field.fileuploadConfig?.minFiles || 0"
                  (ngModelChange)="updateFileUploadMinFiles(fieldIndex, $event)"
                />
                <small class="form-hint">Minimum number of files required (use validation 'required' for at least 1)</small>
              </div>

              <div class="form-group">
                <label>Minimum File Size (bytes)</label>
                <input
                  type="number"
                  min="0"
                  [ngModel]="field.fileuploadConfig?.minFileSize || 0"
                  (ngModelChange)="updateFileUploadMinFileSize(fieldIndex, $event)"
                />
                <small class="form-hint">Minimum size per file in bytes (0 for no minimum)</small>
              </div>

              <div class="form-group">
                <label>Maximum File Size (bytes)</label>
                <input
                  type="number"
                  min="1"
                  [ngModel]="field.fileuploadConfig?.maxFileSize || 10 * 1024 * 1024"
                  (ngModelChange)="updateFileUploadMaxFileSize(fieldIndex, $event)"
                />
                <small class="form-hint">Maximum size per file in bytes (default: 10MB = 10485760 bytes)</small>
              </div>

              <div class="form-group">
                <label>Allowed Extensions</label>
                <input
                  type="text"
                  [ngModel]="getFileUploadAllowedExtensionsString(field)"
                  (ngModelChange)="updateFileUploadAllowedExtensions(fieldIndex, $event)"
                  placeholder="e.g., .pdf, .doc, .docx"
                />
                <small class="form-hint">Comma-separated file extensions (leave empty to allow all)</small>
              </div>

              <div class="form-group">
                <label>Allowed MIME Types</label>
                <input
                  type="text"
                  [ngModel]="getFileUploadAllowedMimeTypesString(field)"
                  (ngModelChange)="updateFileUploadAllowedMimeTypes(fieldIndex, $event)"
                  placeholder="e.g., image/*, application/pdf"
                />
                <small class="form-hint">Comma-separated MIME types (use * for wildcards like image/*)</small>
              </div>

              <div class="form-group">
                <label>Upload Timing</label>
                <select
                  [ngModel]="field.fileuploadConfig?.uploadTiming || 'immediate'"
                  (ngModelChange)="updateFileUploadTiming(fieldIndex, $event)">
                  <option value="immediate">Immediate (upload when selected)</option>
                  <option value="manual">Manual (user clicks upload button)</option>
                </select>
                <small class="form-hint">When files should be uploaded to the server</small>
              </div>

              <div class="form-group checkbox-group">
                <label>
                  <input
                    type="checkbox"
                    [ngModel]="field.fileuploadConfig?.allowDragDrop !== false"
                    (ngModelChange)="updateFileUploadAllowDragDrop(fieldIndex, $event)"
                  />
                  Allow Drag and Drop
                </label>
                <small class="form-hint">Enable drag and drop file selection</small>
              </div>

              <div class="form-group checkbox-group">
                <label>
                  <input
                    type="checkbox"
                    [ngModel]="field.fileuploadConfig?.allowDownload !== false"
                    (ngModelChange)="updateFileUploadAllowDownload(fieldIndex, $event)"
                  />
                  Allow Download
                </label>
                <small class="form-hint">Allow users to download completed files (disable if files need virus scanning first)</small>
              </div>

              <div class="form-group checkbox-group">
                <label>
                  <input
                    type="checkbox"
                    [ngModel]="field.fileuploadConfig?.showFileSize !== false"
                    (ngModelChange)="updateFileUploadShowFileSize(fieldIndex, $event)"
                  />
                  Show File Size
                </label>
                <small class="form-hint">Display file size in the file list</small>
              </div>

              <div class="form-group">
                <label>Upload Button Label</label>
                <input
                  type="text"
                  [ngModel]="field.fileuploadConfig?.uploadButtonLabel || ''"
                  (ngModelChange)="updateFileUploadButtonLabel(fieldIndex, $event)"
                  placeholder="Choose file"
                />
                <small class="form-hint">Text for the file selection button</small>
              </div>

              <div class="form-group">
                <label>Drag & Drop Label</label>
                <input
                  type="text"
                  [ngModel]="field.fileuploadConfig?.dragDropLabel || ''"
                  (ngModelChange)="updateFileUploadDragDropLabel(fieldIndex, $event)"
                  placeholder="Drop files here or click to select"
                />
                <small class="form-hint">Text displayed in the drag and drop zone</small>
              </div>
            </div>
          }

          <!-- Autocomplete Configuration (for autocomplete fields) -->
          @if (field.type === 'autocomplete') {
            <div class="autocomplete-config-section">
              <h4>Autocomplete Configuration</h4>
              <small class="form-hint">Configure search behavior and API fetch handler</small>

              <div class="form-group">
                <label>Fetch Handler *</label>
                <select
                  [ngModel]="field.autocompleteConfig?.fetchHandlerName || ''"
                  (ngModelChange)="updateAutocompleteFetchHandlerName(fieldIndex, $event)"
                >
                  <option value="">-- Select Fetch Handler --</option>
                  @for (handler of availableFetchHandlers(); track handler) {
                    <option [value]="handler">{{ handler }}</option>
                  }
                </select>
                <small class="form-hint">Registered autocomplete fetch handlers</small>
              </div>

              <div class="form-group">
                <label>Min Search Length</label>
                <input
                  type="number"
                  min="1"
                  max="10"
                  [ngModel]="field.autocompleteConfig?.minSearchLength || 2"
                  (ngModelChange)="updateAutocompleteMinSearchLength(fieldIndex, $event)"
                />
                <small class="form-hint">Minimum characters before search triggers</small>
              </div>

              <div class="form-group">
                <label>Debounce (ms)</label>
                <input
                  type="number"
                  min="0"
                  max="2000"
                  step="50"
                  [ngModel]="field.autocompleteConfig?.debounceMs || 300"
                  (ngModelChange)="updateAutocompleteDebounceMs(fieldIndex, $event)"
                />
                <small class="form-hint">Delay before search triggers after typing stops</small>
              </div>

              <div class="form-group">
                <label>Placeholder</label>
                <input
                  type="text"
                  [ngModel]="field.autocompleteConfig?.placeholder || ''"
                  (ngModelChange)="updateAutocompletePlaceholder(fieldIndex, $event)"
                  placeholder="Type to search..."
                />
                <small class="form-hint">Placeholder text for the input</small>
              </div>

              <div class="form-group">
                <label>No Results Message</label>
                <input
                  type="text"
                  [ngModel]="field.autocompleteConfig?.noResultsMessage || ''"
                  (ngModelChange)="updateAutocompleteNoResultsMessage(fieldIndex, $event)"
                  placeholder="No results found"
                />
                <small class="form-hint">Message shown when search returns no results</small>
              </div>

              <div class="form-group">
                <label>Loading Message</label>
                <input
                  type="text"
                  [ngModel]="field.autocompleteConfig?.loadingMessage || ''"
                  (ngModelChange)="updateAutocompleteLoadingMessage(fieldIndex, $event)"
                  placeholder="Loading..."
                />
                <small class="form-hint">Message shown while fetching results</small>
              </div>
            </div>
          }

          <!-- DataGrid Configuration (for datagrid fields) -->
          @if (field.type === 'datagrid') {
            <div class="datagrid-config-section">
              <h4>DataGrid Configuration</h4>

              <!-- Row Label Header -->
              <div class="form-group">
                <label>Row Label Header</label>
                <input
                  type="text"
                  [ngModel]="field.datagridConfig?.rowLabelHeader || ''"
                  (ngModelChange)="updateDataGridRowLabelHeader(fieldIndex, $event)"
                  placeholder="e.g., Year Level"
                />
                <small class="form-hint">Header text for the row labels column</small>
              </div>

              <!-- Totals Configuration -->
              <div class="totals-config">
                <h5>Totals</h5>
                <div class="form-group checkbox-group">
                  <label>
                    <input
                      type="checkbox"
                      [ngModel]="field.datagridConfig?.totals?.showRowTotals"
                      (ngModelChange)="updateDataGridShowRowTotals(fieldIndex, $event)"
                    />
                    Show Row Totals
                  </label>
                  @if (field.datagridConfig?.totals?.showRowTotals) {
                    <input
                      type="text"
                      [ngModel]="field.datagridConfig?.totals?.rowTotalLabel || ''"
                      (ngModelChange)="updateDataGridRowTotalLabel(fieldIndex, $event)"
                      placeholder="Total"
                      class="totals-label-input"
                    />
                  }
                </div>
                <div class="form-group checkbox-group">
                  <label>
                    <input
                      type="checkbox"
                      [ngModel]="field.datagridConfig?.totals?.showColumnTotals"
                      (ngModelChange)="updateDataGridShowColumnTotals(fieldIndex, $event)"
                    />
                    Show Column Totals
                  </label>
                  @if (field.datagridConfig?.totals?.showColumnTotals) {
                    <input
                      type="text"
                      [ngModel]="field.datagridConfig?.totals?.columnTotalLabel || ''"
                      (ngModelChange)="updateDataGridColumnTotalLabel(fieldIndex, $event)"
                      placeholder="Total"
                      class="totals-label-input"
                    />
                  }
                </div>
              </div>

              <!-- Row Labels -->
              <div class="row-labels-section">
                <h5>Row Labels</h5>
                <button class="btn-sm btn-primary" (click)="addDataGridRowLabel(fieldIndex)">+ Add Row</button>

                @for (rowLabel of field.datagridConfig?.rowLabels; track $index; let ri = $index) {
                  <div class="row-label-item">
                    <div class="row-label-header">
                      <strong>{{ rowLabel.label }}</strong>
                      <div class="row-label-actions">
                        <button class="btn-icon" (click)="moveDataGridRowLabelUp(fieldIndex, ri)" title="Move Up">↑</button>
                        <button class="btn-icon" (click)="moveDataGridRowLabelDown(fieldIndex, ri)" title="Move Down">↓</button>
                        <button
                          class="btn-icon btn-danger"
                          (click)="removeDataGridRowLabel(fieldIndex, ri)"
                          [disabled]="field.datagridConfig?.rowLabels?.length === 1"
                          title="Delete">×</button>
                      </div>
                    </div>

                    <div class="form-group">
                      <label>Row ID</label>
                      <input
                        type="text"
                        [ngModel]="rowLabel.id"
                        (ngModelChange)="updateDataGridRowLabelId(fieldIndex, ri, $event)"
                      />
                    </div>

                    <div class="form-group">
                      <label>Row Label</label>
                      <input
                        type="text"
                        [ngModel]="rowLabel.label"
                        (ngModelChange)="updateDataGridRowLabelText(fieldIndex, ri, $event)"
                      />
                    </div>
                  </div>
                }
              </div>

              <!-- Column Groups -->
              <div class="column-groups-section">
                <h5>Column Groups (Optional)</h5>
                <small class="form-hint">Group related columns under a shared header</small>
                <button class="btn-sm btn-primary" (click)="addDataGridColumnGroup(fieldIndex)">+ Add Group</button>

                @for (group of field.datagridConfig?.columnGroups; track $index; let gi = $index) {
                  <div class="column-group-item">
                    <div class="column-group-header">
                      <strong>{{ group.label }}</strong>
                      <button
                        class="btn-icon btn-danger"
                        (click)="removeDataGridColumnGroup(fieldIndex, gi)"
                        title="Delete">×</button>
                    </div>

                    <div class="form-group">
                      <label>Group ID</label>
                      <input
                        type="text"
                        [ngModel]="group.id"
                        (ngModelChange)="updateDataGridColumnGroupId(fieldIndex, gi, $event)"
                      />
                    </div>

                    <div class="form-group">
                      <label>Group Label</label>
                      <input
                        type="text"
                        [ngModel]="group.label"
                        (ngModelChange)="updateDataGridColumnGroupLabel(fieldIndex, gi, $event)"
                      />
                    </div>

                    <div class="form-group">
                      <label>Columns in Group</label>
                      <div class="column-checkboxes">
                        @for (column of field.datagridConfig?.columns; track column.name) {
                          <label class="checkbox-label">
                            <input
                              type="checkbox"
                              [checked]="isDataGridColumnInGroup(fieldIndex, gi, column.name)"
                              (change)="toggleDataGridColumnInGroup(fieldIndex, gi, column.name)"
                            />
                            {{ column.label }}
                          </label>
                        }
                      </div>
                    </div>
                  </div>
                }
              </div>

              <!-- Columns -->
              <div class="columns-section">
                <h5>Columns</h5>
                <button class="btn-sm btn-primary" (click)="addDataGridColumn(fieldIndex)">+ Add Column</button>

                @for (column of field.datagridConfig?.columns; track $index; let ci = $index) {
                  <div class="column-item">
                    <div class="column-header">
                      <strong>{{ column.label }}</strong>
                      @if (column.computed) {
                        <span class="computed-badge">Computed</span>
                      }
                      <div class="column-actions">
                        <button class="btn-icon" (click)="moveDataGridColumnUp(fieldIndex, ci)" title="Move Left">←</button>
                        <button class="btn-icon" (click)="moveDataGridColumnDown(fieldIndex, ci)" title="Move Right">→</button>
                        <button
                          class="btn-icon btn-danger"
                          (click)="removeDataGridColumn(fieldIndex, ci)"
                          [disabled]="field.datagridConfig?.columns?.length === 1"
                          title="Delete">×</button>
                      </div>
                    </div>

                    <div class="form-group">
                      <label>Column Name (ID)</label>
                      <input
                        type="text"
                        [ngModel]="column.name"
                        (ngModelChange)="updateDataGridColumnName(fieldIndex, ci, $event)"
                      />
                    </div>

                    <div class="form-group">
                      <label>Column Label</label>
                      <input
                        type="text"
                        [ngModel]="column.label"
                        (ngModelChange)="updateDataGridColumnLabel(fieldIndex, ci, $event)"
                      />
                    </div>

                    <div class="form-group">
                      <label>Column Type</label>
                      <select
                        [ngModel]="column.type"
                        (ngModelChange)="updateDataGridColumnType(fieldIndex, ci, $event)">
                        @for (type of datagridColumnTypes; track type) {
                          <option [value]="type">{{ type }}</option>
                        }
                      </select>
                    </div>

                    <!-- Computed Column -->
                    <div class="form-group">
                      <label>
                        <input
                          type="checkbox"
                          [ngModel]="column.computed"
                          (ngModelChange)="updateDataGridColumnComputed(fieldIndex, ci, $event)"
                        />
                        Computed (read-only, calculated)
                      </label>
                    </div>

                    @if (column.computed) {
                      <div class="form-group">
                        <label>Formula Expression</label>
                        <input
                          type="text"
                          [ngModel]="column.formula?.expression || ''"
                          (ngModelChange)="updateDataGridColumnFormula(fieldIndex, ci, $event)"
                          placeholder="e.g., students * 0.5"
                        />
                        <small class="form-hint">Use column names as variables (e.g., col1 + col2)</small>
                      </div>
                    }

                    @if (!column.computed) {
                      <div class="form-group">
                        <label>Placeholder</label>
                        <input
                          type="text"
                          [ngModel]="column.placeholder"
                          (ngModelChange)="updateDataGridColumnPlaceholder(fieldIndex, ci, $event)"
                        />
                      </div>
                    }

                    <div class="form-group">
                      <label>Width (1-4)</label>
                      <select
                        [ngModel]="column.width || 1"
                        (ngModelChange)="updateDataGridColumnWidth(fieldIndex, ci, $event)">
                        <option [value]="1">1 (default)</option>
                        <option [value]="2">2 (wider)</option>
                        <option [value]="3">3 (wide)</option>
                        <option [value]="4">4 (widest)</option>
                      </select>
                    </div>

                    <!-- Totals Inclusion -->
                    @if (column.type === 'number') {
                      <div class="form-group checkbox-group">
                        <label>
                          <input
                            type="checkbox"
                            [ngModel]="column.showInColumnTotal !== false"
                            (ngModelChange)="updateDataGridColumnShowInColumnTotal(fieldIndex, ci, $event)"
                          />
                          Include in Column Total
                        </label>
                        <label>
                          <input
                            type="checkbox"
                            [ngModel]="column.showInRowTotal !== false"
                            (ngModelChange)="updateDataGridColumnShowInRowTotal(fieldIndex, ci, $event)"
                          />
                          Include in Row Total
                        </label>
                      </div>
                    }

                    <!-- Column Options (for select type) -->
                    @if (column.type === 'select') {
                      <div class="column-options">
                        <label>Options</label>
                        <button class="btn-sm btn-secondary" (click)="addDataGridColumnOption(fieldIndex, ci)">+ Add Option</button>

                        @for (option of column.options; track $index; let oi = $index) {
                          <div class="option-row">
                            <input
                              type="text"
                              [ngModel]="option.label"
                              (ngModelChange)="updateDataGridColumnOptionLabel(fieldIndex, ci, oi, $event)"
                              placeholder="Label"
                            />
                            <input
                              type="text"
                              [ngModel]="option.value"
                              (ngModelChange)="updateDataGridColumnOptionValue(fieldIndex, ci, oi, $event)"
                              placeholder="Value"
                            />
                            <button class="btn-icon btn-danger" (click)="removeDataGridColumnOption(fieldIndex, ci, oi)">×</button>
                          </div>
                        }
                      </div>
                    }

                    <!-- Column Validations (not for computed columns) -->
                    @if (!column.computed) {
                      <div class="column-validations">
                        <label>Validations</label>
                        <button class="btn-sm btn-secondary" (click)="addDataGridColumnValidation(fieldIndex, ci)">+ Add Validation</button>

                        @for (validation of column.validations; track $index; let vi = $index) {
                          <div class="validation-row">
                            <select
                              [ngModel]="validation.type"
                              (ngModelChange)="updateDataGridColumnValidationType(fieldIndex, ci, vi, $event)">
                              @for (vType of validationTypes; track vType) {
                                <option [value]="vType">{{ vType }}</option>
                              }
                            </select>

                            @if (validation.type === 'minLength' || validation.type === 'maxLength' || validation.type === 'min' || validation.type === 'max') {
                              <input
                                type="number"
                                [ngModel]="validation.value"
                                (ngModelChange)="updateDataGridColumnValidationValue(fieldIndex, ci, vi, $event)"
                                placeholder="Value"
                              />
                            }

                            @if (validation.type === 'pattern') {
                              <input
                                type="text"
                                [ngModel]="validation.value"
                                (ngModelChange)="updateDataGridColumnValidationValue(fieldIndex, ci, vi, $event)"
                                placeholder="Regex pattern"
                              />
                            }

                            <input
                              type="text"
                              [ngModel]="validation.message"
                              (ngModelChange)="updateDataGridColumnValidationMessage(fieldIndex, ci, vi, $event)"
                              placeholder="Error message"
                            />

                            <button class="btn-icon btn-danger" (click)="removeDataGridColumnValidation(fieldIndex, ci, vi)">×</button>
                          </div>

                          <!-- Conditional Validation for DataGrid Column -->
                          <div class="column-condition-section">
                            <label class="condition-toggle-inline">
                              <input
                                type="checkbox"
                                [checked]="!!validation.condition"
                                (change)="toggleDataGridColumnValidationCondition(fieldIndex, ci, vi)"
                              />
                              Conditional
                            </label>

                            @if (validation.condition) {
                              <div class="column-condition-config">
                                <select
                                  [ngModel]="validation.condition.field"
                                  (ngModelChange)="updateDataGridColumnValidationConditionField(fieldIndex, ci, vi, $event)">
                                  @for (f of getAvailableColumnConditionFields(fieldIndex, ci, 'datagrid'); track f.value) {
                                    <option [value]="f.value">{{ f.label }}</option>
                                  }
                                </select>
                                <select
                                  [ngModel]="validation.condition.operator"
                                  (ngModelChange)="updateDataGridColumnValidationConditionOperator(fieldIndex, ci, vi, $event)">
                                  @for (op of conditionOperators; track op) {
                                    <option [value]="op">{{ op }}</option>
                                  }
                                </select>
                                @if (validation.condition.operator === 'equals' || validation.condition.operator === 'notEquals') {
                                  <input
                                    type="text"
                                    [ngModel]="validation.condition.value"
                                    (ngModelChange)="updateDataGridColumnValidationConditionValue(fieldIndex, ci, vi, $event)"
                                    placeholder="Value"
                                  />
                                }
                              </div>
                            }
                          </div>
                        }
                      </div>
                    }
                  </div>
                }
              </div>
            </div>
          }

          <!-- Validations (not for info or formref types) -->
          @if (field.type !== 'info' && field.type !== 'formref') {
            <div class="validations-section">
              <h4>Validations</h4>
              <button class="btn-sm btn-primary" (click)="addValidation(fieldIndex)">+ Add Validation</button>

              @for (validation of field.validations; track $index; let vi = $index) {
                <div class="validation-item">
                  <div class="form-group">
                    <label>Type</label>
                    <select
                      [ngModel]="validation.type"
                      (ngModelChange)="updateValidationType(fieldIndex, vi, $event)">
                      @for (vType of validationTypes; track vType) {
                        <option [value]="vType">{{ vType }}</option>
                      }
                    </select>
                  </div>

                  @if (validation.type === 'minLength' || validation.type === 'maxLength' || validation.type === 'min' || validation.type === 'max') {
                    <div class="form-group">
                      <label>Value</label>
                      <input
                        type="number"
                        [ngModel]="validation.value"
                        (ngModelChange)="updateValidationValue(fieldIndex, vi, $event)"
                      />
                    </div>
                  }

                  @if (validation.type === 'pattern') {
                    <div class="form-group">
                      <label>Pattern (regex)</label>
                      <input
                        type="text"
                        [ngModel]="validation.value"
                        (ngModelChange)="updateValidationValue(fieldIndex, vi, $event)"
                      />
                    </div>
                  }

                  <div class="form-group">
                    <label>Error Message</label>
                    <input
                      type="text"
                      [ngModel]="validation.message"
                      (ngModelChange)="updateValidationMessage(fieldIndex, vi, $event)"
                    />
                  </div>

                  <!-- Conditional Validation -->
                  <div class="condition-section">
                    <div class="form-group condition-toggle">
                      <label>
                        <input
                          type="checkbox"
                          [checked]="!!validation.condition"
                          (change)="toggleValidationCondition(fieldIndex, vi)"
                        />
                        Apply conditionally
                      </label>
                    </div>

                    @if (validation.condition) {
                      <div class="condition-config">
                        <div class="form-group">
                          <label>When field</label>
                          <select
                            [ngModel]="validation.condition.field"
                            (ngModelChange)="updateValidationConditionField(fieldIndex, vi, $event)">
                            @for (f of getAvailableConditionFields(fieldIndex); track f.value) {
                              <option [value]="f.value">{{ f.label }}</option>
                            }
                          </select>
                        </div>

                        <div class="form-group">
                          <label>Operator</label>
                          <select
                            [ngModel]="validation.condition.operator"
                            (ngModelChange)="updateValidationConditionOperator(fieldIndex, vi, $event)">
                            @for (op of conditionOperators; track op) {
                              <option [value]="op">{{ op }}</option>
                            }
                          </select>
                        </div>

                        @if (validation.condition.operator === 'equals' || validation.condition.operator === 'notEquals') {
                          <div class="form-group">
                            <label>Value</label>
                            <input
                              type="text"
                              [ngModel]="validation.condition.value"
                              (ngModelChange)="updateValidationConditionValue(fieldIndex, vi, $event)"
                              placeholder="Enter value"
                            />
                          </div>
                        }
                      </div>
                    }
                  </div>

                  <button class="btn-sm btn-danger" (click)="removeValidation(fieldIndex, vi)">Remove</button>
                </div>
              }
            </div>
          }

          <!-- Async Validation -->
          @if (shouldShowAsyncValidation(field)) {
            <div class="async-validation-section">
              <h4>Async Validation</h4>
              <small class="form-hint">Server-side validation (e.g., check email exists)</small>

              <div class="form-group">
                <label>
                  <input
                    type="checkbox"
                    [checked]="hasAsyncValidation(field)"
                    (change)="toggleAsyncValidation(fieldIndex, $event)"
                  />
                  Enable Async Validation
                </label>
              </div>

              @if (field.asyncValidation) {
                <!-- Validator Name -->
                <div class="form-group">
                  <label>Validator</label>
                  <select
                    [ngModel]="field.asyncValidation.validatorName || ''"
                    (ngModelChange)="updateAsyncValidatorName(fieldIndex, $event)"
                  >
                    <option value="">-- Select Validator --</option>
                    @for (validator of availableAsyncValidators(); track validator) {
                      <option [value]="validator">{{ validator }}</option>
                    }
                  </select>
                  <small class="form-hint">Registered async validators</small>
                </div>

                <!-- Trigger -->
                @if (field.asyncValidation.validatorName) {
                  <div class="form-group">
                    <label>Trigger</label>
                    <select
                      [ngModel]="field.asyncValidation.trigger || 'blur'"
                      (ngModelChange)="updateAsyncValidationTrigger(fieldIndex, $event)"
                    >
                      <option value="blur">On Blur (default)</option>
                      <option value="change">On Change</option>
                    </select>
                  </div>

                  <!-- Debounce (only for 'change' trigger) -->
                  @if (field.asyncValidation.trigger === 'change') {
                    <div class="form-group">
                      <label>Debounce (ms)</label>
                      <input
                        type="number"
                        [ngModel]="field.asyncValidation.debounceMs ?? 300"
                        (ngModelChange)="updateAsyncValidationDebounce(fieldIndex, $event)"
                        placeholder="300"
                      />
                      <small class="form-hint">Delay before validation runs</small>
                    </div>
                  }

                  <!-- Parameters (optional) -->
                  <div class="form-group">
                    <label>Parameters (optional)</label>
                    <button class="btn-sm btn-secondary" (click)="addAsyncValidationParam(fieldIndex)">+ Add Parameter</button>

                    @if (field.asyncValidation.params) {
                      @for (paramKey of getAsyncValidationParamKeys(field); track paramKey) {
                        <div class="param-row">
                          <input
                            type="text"
                            [value]="paramKey"
                            (change)="updateAsyncValidationParamKey(fieldIndex, paramKey, $any($event.target).value)"
                            placeholder="Key"
                          />
                          <input
                            type="text"
                            [value]="field.asyncValidation.params![paramKey]"
                            (change)="updateAsyncValidationParamValue(fieldIndex, paramKey, $any($event.target).value)"
                            placeholder="Value"
                          />
                          <button class="btn-icon btn-danger" (click)="removeAsyncValidationParam(fieldIndex, paramKey)">×</button>
                        </div>
                      }
                    }
                  </div>
                }
              }
            </div>
          }

          <!-- JSON Preview -->
          <div class="json-preview-section">
            <h4>JSON Preview</h4>
            <pre class="json-preview"><code>{{ getFieldJson(field) }}</code></pre>
          </div>
        </div>
      } @else {
        <div class="empty-editor">
          <p>Select a section or field to edit, or add new ones to get started</p>
        </div>
      }
      } <!-- end @if (!versionPreviewMode()) -->
    </div>
  </div>

  <!-- JSON Editor Modal -->
  @if (showJsonEditor()) {
    <div class="modal-overlay" (click)="showJsonEditor.set(false)">
      <div class="modal modal-lg" (click)="$event.stopPropagation()">
        <div class="modal-header">
          @switch (jsonEditorMode()) {
            @case ('export') {
              <h3>Export JSON</h3>
            }
            @case ('import') {
              <h3>Import JSON</h3>
            }
            @case ('edit') {
              <h3>Edit Raw JSON</h3>
            }
          }
          <button class="btn-close" (click)="showJsonEditor.set(false)">×</button>
        </div>
        <div class="modal-body">
          @if (jsonEditorMode() === 'edit' && jsonEditorError()) {
            <div class="json-error">{{ jsonEditorError() }}</div>
          }
          <textarea
            [(ngModel)]="jsonEditorContent"
            rows="20"
            [placeholder]="jsonEditorMode() === 'export' ? '' : 'Paste JSON configuration here...'"
            [readonly]="jsonEditorMode() === 'export'"
            [class.has-error]="jsonEditorMode() === 'edit' && jsonEditorError()"
            (input)="jsonEditorMode() === 'edit' ? validateJsonContent() : null"
          ></textarea>
        </div>
        <div class="modal-footer">
          @switch (jsonEditorMode()) {
            @case ('export') {
              <button class="btn btn-secondary" (click)="showJsonEditor.set(false)">Close</button>
              <button class="btn btn-primary" (click)="copyJsonToClipboard()">{{ copyButtonText() }}</button>
            }
            @case ('import') {
              <button class="btn btn-secondary" (click)="showJsonEditor.set(false)">Cancel</button>
              <button class="btn btn-primary" (click)="importJson()">Import</button>
            }
            @case ('edit') {
              <button class="btn btn-secondary" (click)="showJsonEditor.set(false)">Cancel</button>
              <button class="btn btn-primary" (click)="applyJsonEdit()" [disabled]="!!jsonEditorError()">Apply Changes</button>
            }
          }
        </div>
      </div>
    </div>
  }

  <!-- Version Description Modal -->
  @if (showVersionDescriptionModal()) {
    <div class="modal-overlay" (click)="cancelCreateVersion()">
      <div class="modal modal-sm" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Create Version</h3>
          <button class="btn-close" (click)="cancelCreateVersion()">×</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Description (optional)</label>
            <textarea
              rows="3"
              [(ngModel)]="versionDescriptionInput"
              placeholder="Enter a description for this version..."
            ></textarea>
            <small class="form-hint">Add a note to help identify this version later</small>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="cancelCreateVersion()">Cancel</button>
          <button class="btn btn-primary" (click)="createVersionWithNote()">Create Version</button>
        </div>
      </div>
    </div>
  }
</div>
