@if (isFormReady()) {
<form
  class="ngx-df df-form"
  [formGroup]="form"
  [attr.data-form-id]="config().id"
  [attr.data-form-valid]="valid"
  [attr.data-form-dirty]="form.dirty"
  [attr.data-form-touched]="form.touched"
  [attr.data-form-validating]="validating"
  [attr.data-form-readonly]="readOnly"
  [attr.data-form-disabled]="disabled"
  [attr.data-wizard-mode]="isWizardMode">

  <!-- Field template defined inside form for formControlName to work -->
  <ng-template #fieldTemplate let-field>
    <!-- Info field type - renders markdown content block -->
    @if (field.type === 'info') {
      <div
        class="df-field df-info-block"
        [attr.data-field-name]="field.name"
        [attr.data-field-type]="field.type"
        [attr.data-field-archived]="field.archived || false"
        [attr.data-field-hidden]="false"
        [ngClass]="field.cssClass">
        <div
          class="df-info-content"
          [innerHTML]="parseMarkdown(field.content)">
        </div>
      </div>
    } @else {
      <!-- Regular field types -->
      <div
        class="df-field"
        [class.df-field-width-1]="(field.width || 1) === 1"
        [class.df-field-width-2]="field.width === 2"
        [class.df-field-width-3]="field.width === 3"
        [class.df-field-width-4]="field.width === 4"
        [class.df-no-label]="!field.label"
        [attr.data-field-name]="field.name"
        [attr.data-field-type]="field.type"
        [attr.data-field-archived]="field.archived || false"
        [attr.data-field-hidden]="false"
        [attr.data-field-valid]="!hasError(field.name)"
        [attr.data-field-touched]="form.get(field.name)?.touched"
        [attr.data-field-dirty]="form.get(field.name)?.dirty"
        [attr.data-field-disabled]="form.get(field.name)?.disabled"
        [attr.data-field-required]="isFieldRequired(field)"
        [attr.data-field-validating]="isFieldValidating(field.name)"
        [ngClass]="field.cssClass">

        @if (field.label) {
          <label
            class="df-label"
            [for]="field.name"
            [attr.data-label-for]="field.name">
            {{ field.label }}
            @if (isFieldRequired(field)) {
              <span class="df-required-indicator">*</span>
            }
            @if (field.description) {
              <span
                class="df-info-icon"
                (click)="togglePopover(field.name); $event.stopPropagation(); $event.preventDefault()"
                [attr.data-popover-open]="activePopover === field.name"
                title="Click for more information">
                &#9432;
              </span>
              @if (activePopover === field.name) {
                <span class="df-popover">
                  <span class="df-popover-content">{{ field.description }}</span>
                  <button
                    type="button"
                    class="df-popover-close"
                    (click)="closePopover(); $event.stopPropagation(); $event.preventDefault()">
                    &times;
                  </button>
                </span>
              }
            }
          </label>
        }

        <div class="df-input-container">
        @switch (field.type) {
          @case ('text') {
            <input
              class="df-input"
              [id]="field.name"
              [formControlName]="field.name"
              type="text"
              [placeholder]="field.placeholder || ''"
              [attr.data-input-type]="field.type"
              [readonly]="readOnly"
            />
          }
          @case ('email') {
            <input
              class="df-input"
              [id]="field.name"
              [formControlName]="field.name"
              type="email"
              [placeholder]="field.placeholder || ''"
              [attr.data-input-type]="field.type"
              [readonly]="readOnly"
            />
          }
          @case ('number') {
            <input
              class="df-input"
              [id]="field.name"
              [formControlName]="field.name"
              type="number"
              [placeholder]="field.placeholder || ''"
              [attr.data-input-type]="field.type"
              [readonly]="readOnly"
            />
          }
          @case ('textarea') {
            <textarea
              class="df-input"
              [id]="field.name"
              [formControlName]="field.name"
              [placeholder]="field.placeholder || ''"
              [attr.data-input-type]="field.type"
              rows="4"
              [readonly]="readOnly"
            ></textarea>
          }
          @case ('date') {
            <input
              class="df-input"
              [id]="field.name"
              [formControlName]="field.name"
              type="date"
              [attr.data-input-type]="field.type"
              [readonly]="readOnly"
            />
          }
          @case ('select') {
            <select
              class="df-input"
              [id]="field.name"
              [formControlName]="field.name"
              [attr.data-input-type]="field.type"
              [attr.tabindex]="readOnly ? -1 : null"
              [style.pointer-events]="readOnly ? 'none' : null">
              @if (field.placeholder) {
                <option value="" disabled>{{ field.placeholder }}</option>
              }
              <option value="">--</option>
              @for (option of field.options; track option.value) {
                <option [value]="option.value">{{ option.label }}</option>
              }
            </select>
          }
          @case ('radio') {
            <div
              class="df-radio-group"
              role="radiogroup"
              [attr.aria-labelledby]="field.name + '-label'"
              [style.pointer-events]="readOnly ? 'none' : null">
              @for (option of field.options; track option.value) {
                <label
                  class="df-radio-option"
                  [attr.data-option-value]="option.value">
                  <input
                    type="radio"
                    class="df-radio-input"
                    [formControlName]="field.name"
                    [attr.name]="field.name"
                    [value]="option.value"
                  />
                  <span class="df-radio-label">{{ option.label }}</span>
                </label>
              }
            </div>
          }
          @case ('checkbox') {
            @if (field.options && field.options.length > 0) {
              <div
                class="df-checkbox-group"
                role="group"
                [attr.aria-labelledby]="field.name + '-label'"
                [style.pointer-events]="readOnly ? 'none' : null">
                @for (option of field.options; track option.value) {
                  <label
                    class="df-checkbox-option"
                    [attr.data-option-value]="option.value"
                    [attr.data-option-selected]="isCheckboxOptionSelected(field.name, option.value)">
                    <input
                      type="checkbox"
                      class="df-checkbox-input"
                      [attr.name]="field.name + '_' + option.value"
                      [checked]="isCheckboxOptionSelected(field.name, option.value)"
                      (change)="toggleCheckboxOption(field.name, option.value)"
                    />
                    <span class="df-checkbox-label" [innerHTML]="parseMarkdown(option.label)"></span>
                  </label>
                }
              </div>
            } @else {
              <input
                class="df-checkbox-single"
                [id]="field.name"
                [formControlName]="field.name"
                type="checkbox"
                [style.pointer-events]="readOnly ? 'none' : null"
              />
            }
          }
          @case ('table') {
            @if (field.tableConfig) {
              <div
                class="df-table-container"
                [attr.data-table-name]="field.name"
                [attr.data-row-mode]="field.tableConfig.rowMode"
                [attr.data-table-valid]="isTableValid(field.name)">

                <table class="df-table" [attr.data-table-for]="field.name">
                  <thead class="df-table-header">
                    <tr class="df-table-header-row">
                      @for (column of field.tableConfig.columns; track column.name) {
                        <th
                          class="df-table-header-cell"
                          [attr.data-column-name]="column.name"
                          [attr.data-column-type]="column.type"
                          [attr.data-column-width]="column.width || 1">
                          {{ column.label }}
                          @if (hasColumnRequiredValidation(column)) {
                            <span class="df-required-indicator">*</span>
                          }
                        </th>
                      }
                      @if (field.tableConfig.rowMode === 'dynamic') {
                        <th class="df-table-header-cell df-table-actions-column"></th>
                      }
                    </tr>
                  </thead>

                  <tbody class="df-table-body" [formArrayName]="field.name">
                    @for (rowControl of getTableFormArray(field.name)?.controls; track $index; let rowIndex = $index) {
                      <tr
                        class="df-table-row"
                        [formGroupName]="rowIndex"
                        [attr.data-row-index]="rowIndex"
                        [attr.data-row-empty]="isTableRowEmpty(field.name, rowIndex)">

                        @for (column of field.tableConfig.columns; track column.name) {
                          <td
                            class="df-table-cell"
                            [attr.data-column-name]="column.name"
                            [attr.data-column-label]="column.label"
                            [attr.data-cell-valid]="!hasTableCellError(field.name, rowIndex, column.name)"
                            [attr.data-cell-row]="rowIndex"
                            (mouseenter)="hasTableCellError(field.name, rowIndex, column.name) ? showCellTooltip(field.name, rowIndex, column.name) : null"
                            (mouseleave)="hideCellTooltip()"
                            (focusin)="hasTableCellError(field.name, rowIndex, column.name) ? showCellTooltip(field.name, rowIndex, column.name) : null"
                            (focusout)="hideCellTooltip()">

                            @switch (column.type) {
                              @case ('text') {
                                <input
                                  type="text"
                                  class="df-table-input"
                                  [formControlName]="column.name"
                                  [placeholder]="column.placeholder || ''"
                                  [attr.data-input-type]="column.type"
                                  [readonly]="readOnly"
                                />
                              }
                              @case ('number') {
                                <input
                                  type="number"
                                  class="df-table-input"
                                  [formControlName]="column.name"
                                  [placeholder]="column.placeholder || ''"
                                  [attr.data-input-type]="column.type"
                                  [readonly]="readOnly"
                                />
                              }
                              @case ('date') {
                                <input
                                  type="date"
                                  class="df-table-input"
                                  [formControlName]="column.name"
                                  [attr.data-input-type]="column.type"
                                  [readonly]="readOnly"
                                />
                              }
                              @case ('select') {
                                <select
                                  class="df-table-input"
                                  [formControlName]="column.name"
                                  [attr.data-input-type]="column.type"
                                  [attr.tabindex]="readOnly ? -1 : null"
                                  [style.pointer-events]="readOnly ? 'none' : null">
                                  @if (column.placeholder) {
                                    <option value="" disabled>{{ column.placeholder }}</option>
                                  }
                                  <option value="">--</option>
                                  @for (option of column.options; track option.value) {
                                    <option [value]="option.value">{{ option.label }}</option>
                                  }
                                </select>
                              }
                            }

                            @if (hasTableCellError(field.name, rowIndex, column.name) && isCellTooltipActive(field.name, rowIndex, column.name)) {
                              <div class="df-cell-error-tooltip">
                                {{ getTableCellErrorMessage(field, rowIndex, column.name) }}
                              </div>
                            }
                          </td>
                        }

                        @if (field.tableConfig.rowMode === 'dynamic') {
                          <td class="df-table-cell df-table-actions-cell">
                            <button
                              type="button"
                              class="df-table-action"
                              data-table-action="remove"
                              [disabled]="!canRemoveTableRow(field)"
                              (click)="removeTableRow(field, rowIndex)"
                              [attr.aria-label]="field.tableConfig.removeRowLabel || 'Remove row'">
                              &times;
                            </button>
                          </td>
                        }
                      </tr>
                    }
                  </tbody>
                </table>

                @if (field.tableConfig.rowMode === 'dynamic') {
                  <div class="df-table-footer">
                    <button
                      type="button"
                      class="df-table-action"
                      data-table-action="add"
                      [disabled]="!canAddTableRow(field)"
                      (click)="addTableRow(field)">
                      {{ field.tableConfig.addRowLabel || 'Add row' }}
                    </button>
                  </div>
                }
              </div>
            }
          }
          @case ('phone') {
            @if (field.phoneConfig) {
              <div
                class="df-phone-container"
                [formGroupName]="field.name"
                [attr.data-phone-valid]="isPhoneValid(field.name)">
                <select
                  class="df-phone-country-code"
                  formControlName="countryCode"
                  [attr.data-input-type]="'phone-country'"
                  [attr.tabindex]="readOnly ? -1 : null"
                  [style.pointer-events]="readOnly ? 'none' : null">
                  @for (country of field.phoneConfig.countryCodes; track country.code) {
                    <option [value]="country.code">
                      @if (country.flag) {
                        {{ country.flag }}
                      }
                      {{ country.code }} ({{ country.country }})
                    </option>
                  }
                </select>
                <input
                  type="tel"
                  class="df-phone-number"
                  formControlName="number"
                  [placeholder]="field.placeholder || 'Phone number'"
                  [attr.data-input-type]="'phone-number'"
                  (input)="onPhoneNumberInput($event, field.name)"
                  inputmode="numeric"
                  pattern="[0-9]*"
                  [readonly]="readOnly"
                />
              </div>
            }
            @if (hasPhoneError(field.name)) {
              <div
                class="df-validation-error"
                [attr.data-error-for]="field.name">
                {{ getPhoneErrorMessage(field.name) }}
              </div>
            }
          }
          @case ('daterange') {
            <div
              class="df-daterange-container"
              [formGroupName]="field.name"
              [attr.data-daterange-valid]="!hasDateRangeError(field.name)">
              <div class="df-daterange-field df-daterange-from-field">
                @if (field.daterangeConfig?.fromLabel) {
                  <label class="df-daterange-label df-daterange-from-label">
                    {{ field.daterangeConfig.fromLabel }}
                  </label>
                }
                <input
                  type="date"
                  class="df-daterange-input df-daterange-from"
                  formControlName="fromDate"
                  [attr.data-input-type]="'daterange-from'"
                  [readonly]="readOnly"
                />
              </div>
              <span class="df-daterange-separator">
                {{ field.daterangeConfig?.separatorText || 'to' }}
              </span>
              <div class="df-daterange-field df-daterange-to-field">
                @if (field.daterangeConfig?.toLabel) {
                  <label class="df-daterange-label df-daterange-to-label">
                    {{ field.daterangeConfig.toLabel }}
                  </label>
                }
                <input
                  type="date"
                  class="df-daterange-input df-daterange-to"
                  formControlName="toDate"
                  [attr.data-input-type]="'daterange-to'"
                  [readonly]="readOnly"
                />
              </div>
            </div>
            @if (hasDateRangeError(field.name)) {
              <div
                class="df-validation-error"
                [attr.data-error-for]="field.name">
                {{ getDateRangeErrorMessage(field.name) }}
              </div>
            }
          }
          @case ('datagrid') {
            @if (field.datagridConfig) {
              <div
                class="df-datagrid-container"
                [attr.data-datagrid-name]="field.name"
                [attr.data-datagrid-valid]="isDataGridValid(field.name)"
                [attr.data-has-column-groups]="hasDataGridColumnGroups(field)"
                [attr.data-has-row-totals]="hasDataGridRowTotals(field)"
                [attr.data-has-column-totals]="hasDataGridColumnTotals(field)">

                <table class="df-datagrid" [attr.data-datagrid-for]="field.name">
                  <!-- Column width definitions with explicit equal widths -->
                  <colgroup>
                    <col class="df-col-row-label" style="width: 80px" />
                    @for (column of field.datagridConfig.columns; track column.name) {
                      <col class="df-col-data" [style.width]="getDataGridDataColumnWidth(field)" />
                    }
                    @if (hasDataGridRowTotals(field)) {
                      <col class="df-col-total" style="width: 80px" />
                    }
                  </colgroup>

                  <!-- Two-tier header: Column Groups -->
                  @if (hasDataGridColumnGroups(field)) {
                    <thead class="df-datagrid-header df-datagrid-header-groups">
                      <!-- First row: Group headers and ungrouped columns in column order -->
                      <tr class="df-datagrid-group-row">
                        <!-- Row label column header (spans both rows) -->
                        <th
                          class="df-datagrid-header-cell df-row-label-header"
                          rowspan="2">
                          {{ field.datagridConfig.rowLabelHeader || '' }}
                        </th>

                        <!-- Headers in column order -->
                        @for (item of getDataGridOrderedHeaderItems(field); track item.type === 'group' ? item.group.id : item.column.name) {
                          @if (item.type === 'group') {
                            <th
                              class="df-datagrid-header-cell df-column-group"
                              [attr.data-column-group-id]="item.group.id"
                              [attr.data-column-group-label]="item.group.label"
                              [attr.colspan]="item.group.columnIds.length">
                              {{ item.group.label }}
                            </th>
                          } @else {
                            <th
                              class="df-datagrid-header-cell df-column-ungrouped"
                              [attr.data-column-name]="item.column.name"
                              [attr.data-column-type]="item.column.type"
                              [attr.data-column-computed]="item.column.computed || false"
                              [attr.data-column-width]="item.column.width || 1"
                              rowspan="2">
                              {{ item.column.label }}
                              @if (!item.column.computed && hasDataGridColumnRequiredValidation(item.column)) {
                                <span class="df-required-indicator">*</span>
                              }
                            </th>
                          }
                        }

                        <!-- Row total header (spans both rows) -->
                        @if (hasDataGridRowTotals(field)) {
                          <th
                            class="df-datagrid-header-cell df-row-total-header"
                            rowspan="2">
                            {{ field.datagridConfig.totals?.rowTotalLabel || 'Total' }}
                          </th>
                        }
                      </tr>

                      <!-- Second row: Individual columns within groups (in column order) -->
                      <tr class="df-datagrid-column-row">
                        @for (item of getDataGridOrderedHeaderItems(field); track item.type === 'group' ? item.group.id : item.column.name) {
                          @if (item.type === 'group') {
                            @for (columnName of item.group.columnIds; track columnName) {
                              <th
                                class="df-datagrid-header-cell"
                                [attr.data-column-name]="columnName"
                                [attr.data-column-type]="getDataGridColumn(field, columnName)?.type"
                                [attr.data-column-computed]="getDataGridColumn(field, columnName)?.computed || false"
                                [attr.data-column-width]="getDataGridColumn(field, columnName)?.width || 1"
                                [attr.data-in-group]="item.group.id">
                                {{ getDataGridColumn(field, columnName)?.label }}
                                @if (!getDataGridColumn(field, columnName)?.computed && hasDataGridColumnRequiredValidation(getDataGridColumn(field, columnName)!)) {
                                  <span class="df-required-indicator">*</span>
                                }
                              </th>
                            }
                          }
                        }
                      </tr>
                    </thead>
                  } @else {
                    <!-- Single-tier header (no groups) -->
                    <thead class="df-datagrid-header">
                      <tr class="df-datagrid-header-row">
                        <th class="df-datagrid-header-cell df-row-label-header">
                          {{ field.datagridConfig.rowLabelHeader || '' }}
                        </th>
                        @for (column of field.datagridConfig.columns; track column.name) {
                          <th
                            class="df-datagrid-header-cell"
                            [attr.data-column-name]="column.name"
                            [attr.data-column-type]="column.type"
                            [attr.data-column-computed]="column.computed || false"
                            [attr.data-column-width]="column.width || 1">
                            {{ column.label }}
                            @if (!column.computed && hasDataGridColumnRequiredValidation(column)) {
                              <span class="df-required-indicator">*</span>
                            }
                          </th>
                        }
                        @if (hasDataGridRowTotals(field)) {
                          <th class="df-datagrid-header-cell df-row-total-header">
                            {{ field.datagridConfig.totals?.rowTotalLabel || 'Total' }}
                          </th>
                        }
                      </tr>
                    </thead>
                  }

                  <!-- Data rows -->
                  <tbody class="df-datagrid-body" [formGroupName]="field.name">
                    @for (rowLabel of field.datagridConfig.rowLabels; track rowLabel.id) {
                      <tr
                        class="df-datagrid-row"
                        [formGroupName]="rowLabel.id"
                        [attr.data-row-id]="rowLabel.id"
                        [attr.data-row-label]="rowLabel.label">

                        <!-- Row label cell -->
                        <td
                          class="df-datagrid-cell df-row-label-cell"
                          [attr.data-row-label-header]="field.datagridConfig.rowLabelHeader || ''">
                          {{ rowLabel.label }}
                        </td>

                        <!-- Data cells -->
                        @for (column of field.datagridConfig.columns; track column.name) {
                          <td
                            class="df-datagrid-cell"
                            [attr.data-column-name]="column.name"
                            [attr.data-column-label]="column.label"
                            [attr.data-column-group-label]="getDataGridColumnGroupLabel(field, column.name) || null"
                            [attr.data-column-type]="column.type"
                            [attr.data-column-computed]="column.computed || false"
                            [attr.data-cell-valid]="column.computed || !hasDataGridCellError(field.name, rowLabel.id, column.name)">

                            @if (column.computed) {
                              <!-- Computed cell (read-only) -->
                              <span class="df-datagrid-computed-value">
                                {{ getDataGridComputedValue(field, rowLabel.id, column) }}
                              </span>
                            } @else {
                              <!-- Editable cell -->
                              @switch (column.type) {
                                @case ('text') {
                                  <input
                                    type="text"
                                    class="df-datagrid-input"
                                    [formControlName]="column.name"
                                    [placeholder]="column.placeholder || ''"
                                    [attr.data-input-type]="column.type"
                                    [readonly]="readOnly"
                                  />
                                }
                                @case ('number') {
                                  <input
                                    type="number"
                                    class="df-datagrid-input"
                                    [formControlName]="column.name"
                                    [placeholder]="column.placeholder || ''"
                                    [attr.data-input-type]="column.type"
                                    [readonly]="readOnly"
                                  />
                                }
                                @case ('date') {
                                  <input
                                    type="date"
                                    class="df-datagrid-input"
                                    [formControlName]="column.name"
                                    [attr.data-input-type]="column.type"
                                    [readonly]="readOnly"
                                  />
                                }
                                @case ('select') {
                                  <select
                                    class="df-datagrid-input"
                                    [formControlName]="column.name"
                                    [attr.data-input-type]="column.type"
                                    [attr.tabindex]="readOnly ? -1 : null"
                                    [style.pointer-events]="readOnly ? 'none' : null">
                                    <option value="">--</option>
                                    @for (option of column.options; track option.value) {
                                      <option [value]="option.value">{{ option.label }}</option>
                                    }
                                  </select>
                                }
                              }
                            }
                          </td>
                        }

                        <!-- Row total cell -->
                        @if (hasDataGridRowTotals(field)) {
                          <td
                            class="df-datagrid-cell df-row-total-cell"
                            data-is-total-column="true"
                            [attr.data-total-label]="field.datagridConfig.totals?.rowTotalLabel || 'Total'">
                            <span class="df-datagrid-computed-value">
                              {{ getDataGridRowTotal(field, rowLabel.id) }}
                            </span>
                          </td>
                        }
                      </tr>
                    }

                    <!-- Column totals row -->
                    @if (hasDataGridColumnTotals(field)) {
                      <tr class="df-datagrid-row" data-is-total-row="true">
                        <td class="df-datagrid-cell df-row-label-cell df-total-label-cell">
                          {{ field.datagridConfig.totals?.columnTotalLabel || 'Total' }}
                        </td>
                        @for (column of field.datagridConfig.columns; track column.name) {
                          <td
                            class="df-datagrid-cell df-column-total-cell"
                            [attr.data-column-name]="column.name"
                            [attr.data-column-label]="column.label"
                            data-is-total-row="true">
                            <span class="df-datagrid-computed-value">
                              {{ getDataGridColumnTotal(field, column.name) }}
                            </span>
                          </td>
                        }
                        @if (hasDataGridRowTotals(field)) {
                          <td class="df-datagrid-cell df-grand-total-cell" data-is-total-row="true" data-is-total-column="true">
                            <span class="df-datagrid-computed-value">
                              {{ getDataGridGrandTotal(field) }}
                            </span>
                          </td>
                        }
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            }
          }
          @case ('formref') {
            @if (field.formrefConfig && getResolvedFormRef(field.name)) {
              <div
                class="df-formref-container"
                                [formGroupName]="field.name"
                [attr.data-formref-name]="field.name"
                [attr.data-formref-form-id]="field.formrefConfig.formId"
                [attr.data-formref-valid]="!hasFormRefError(field.name)"
                [attr.data-formref-show-sections]="field.formrefConfig.showSections || false">

                <!-- Render sections if showSections is enabled -->
                @if (field.formrefConfig.showSections) {
                  @for (section of getFormRefSections(field); track section.id) {
                    <div
                      class="df-formref-section"
                                            [attr.data-formref-section-id]="section.id">
                      <header class="df-formref-section-header" >{{ section.title }}</header>
                      @if (section.description) {
                        <div class="df-formref-section-description" >{{ section.description }}</div>
                      }
                      <!-- Fields in this section -->
                      @for (embeddedField of getFormRefFields(field); track embeddedField.name) {
                        @if (embeddedField.sectionId === section.id) {
                          <div
                            class="df-formref-field"
                                                        [attr.data-formref-field-name]="embeddedField.name"
                            [attr.data-formref-field-type]="embeddedField.type"
                            [attr.data-field-valid]="getFormRefFormGroup(field.name)?.get(embeddedField.name)?.valid !== false || !getFormRefFormGroup(field.name)?.get(embeddedField.name)?.touched"
                            [attr.data-field-touched]="getFormRefFormGroup(field.name)?.get(embeddedField.name)?.touched"
                            [attr.data-field-required]="embeddedField.validations && embeddedField.validations.length > 0 && embeddedField.validations[0].type === 'required'">
                            <label
                              class="df-formref-label"
                              [for]="embeddedField.name"
                              >
                              {{ embeddedField.label }}
                              @if (embeddedField.validations && embeddedField.validations.length > 0 && embeddedField.validations[0].type === 'required') {
                                <span class="df-required-indicator" >*</span>
                              }
                            </label>
                            <div class="df-formref-input-container" >
                              @switch (embeddedField.type) {
                                @case ('text') {
                                  <input
                                    [id]="embeddedField.name"
                                    [formControlName]="embeddedField.name"
                                    type="text"
                                    [placeholder]="embeddedField.placeholder || ''"
                                    class="df-formref-input"
                                                                      />
                                }
                                @case ('email') {
                                  <input
                                    [id]="embeddedField.name"
                                    [formControlName]="embeddedField.name"
                                    type="email"
                                    [placeholder]="embeddedField.placeholder || ''"
                                    class="df-formref-input"
                                                                      />
                                }
                                @case ('number') {
                                  <input
                                    [id]="embeddedField.name"
                                    [formControlName]="embeddedField.name"
                                    type="number"
                                    [placeholder]="embeddedField.placeholder || ''"
                                    class="df-formref-input"
                                                                      />
                                }
                                @case ('textarea') {
                                  <textarea
                                    [id]="embeddedField.name"
                                    [formControlName]="embeddedField.name"
                                    [placeholder]="embeddedField.placeholder || ''"
                                    class="df-formref-input"
                                                                        rows="4"
                                  ></textarea>
                                }
                                @case ('date') {
                                  <input
                                    [id]="embeddedField.name"
                                    [formControlName]="embeddedField.name"
                                    type="date"
                                    class="df-formref-input"
                                                                      />
                                }
                                @case ('select') {
                                  <select
                                    [id]="embeddedField.name"
                                    [formControlName]="embeddedField.name"
                                    class="df-formref-input"
                                                                        [style.pointer-events]="readOnly ? 'none' : null">
                                    @if (embeddedField.placeholder) {
                                      <option value="" disabled>{{ embeddedField.placeholder }}</option>
                                    }
                                    <option value="">--</option>
                                    @for (option of embeddedField.options; track option.value) {
                                      <option [value]="option.value">{{ option.label }}</option>
                                    }
                                  </select>
                                }
                                @case ('radio') {
                                  <div class="df-formref-radio-group"  [style.pointer-events]="readOnly ? 'none' : null">
                                    @for (option of embeddedField.options; track option.value) {
                                      <label class="df-formref-radio-option" >
                                        <input
                                          type="radio"
                                          [formControlName]="embeddedField.name"
                                          [attr.name]="embeddedField.name"
                                          [value]="option.value"
                                          class="df-formref-radio-input"
                                                                                  />
                                        <span class="df-formref-radio-label" >{{ option.label }}</span>
                                      </label>
                                    }
                                  </div>
                                }
                                @case ('checkbox') {
                                  @if (embeddedField.options && embeddedField.options.length > 0) {
                                    <div class="df-formref-checkbox-group"  [style.pointer-events]="readOnly ? 'none' : null">
                                      @for (option of embeddedField.options; track option.value) {
                                        <label class="df-formref-checkbox-option" >
                                          <input
                                            type="checkbox"
                                            [attr.name]="embeddedField.name + '_' + option.value"
                                            class="df-formref-checkbox-input"
                                                                                      />
                                          <span class="df-formref-checkbox-label" >{{ option.label }}</span>
                                        </label>
                                      }
                                    </div>
                                  } @else {
                                    <input
                                      [id]="embeddedField.name"
                                      [formControlName]="embeddedField.name"
                                      type="checkbox"
                                      class="df-formref-checkbox-single"
                                                                            [style.pointer-events]="readOnly ? 'none' : null"
                                    />
                                  }
                                }
                              }
                            </div>
                          </div>
                        }
                      }
                    </div>
                  }
                  <!-- Fields without section -->
                  @for (embeddedField of getFormRefFields(field); track embeddedField.name) {
                    @if (!embeddedField.sectionId) {
                      <div
                                                [attr.data-formref-field-name]="embeddedField.name"
                        [attr.data-formref-field-type]="embeddedField.type"
                        [attr.data-field-valid]="getFormRefFormGroup(field.name)?.get(embeddedField.name)?.valid !== false || !getFormRefFormGroup(field.name)?.get(embeddedField.name)?.touched"
                        [attr.data-field-touched]="getFormRefFormGroup(field.name)?.get(embeddedField.name)?.touched"
                        [attr.data-field-required]="embeddedField.validations && embeddedField.validations.length > 0 && embeddedField.validations[0].type === 'required'">
                        <label
                          [for]="embeddedField.name"
                          >
                          {{ embeddedField.label }}
                          @if (embeddedField.validations && embeddedField.validations.length > 0 && embeddedField.validations[0].type === 'required') {
                            <span >*</span>
                          }
                        </label>
                        <div >
                          @switch (embeddedField.type) {
                            @case ('text') {
                              <input
                                [id]="embeddedField.name"
                                [formControlName]="embeddedField.name"
                                type="text"
                                [placeholder]="embeddedField.placeholder || ''"
                                                              />
                            }
                            @case ('email') {
                              <input
                                [id]="embeddedField.name"
                                [formControlName]="embeddedField.name"
                                type="email"
                                [placeholder]="embeddedField.placeholder || ''"
                                                              />
                            }
                            @case ('number') {
                              <input
                                [id]="embeddedField.name"
                                [formControlName]="embeddedField.name"
                                type="number"
                                [placeholder]="embeddedField.placeholder || ''"
                                                              />
                            }
                            @case ('textarea') {
                              <textarea
                                [id]="embeddedField.name"
                                [formControlName]="embeddedField.name"
                                [placeholder]="embeddedField.placeholder || ''"
                                                                rows="4"
                              ></textarea>
                            }
                            @case ('date') {
                              <input
                                [id]="embeddedField.name"
                                [formControlName]="embeddedField.name"
                                type="date"
                                                              />
                            }
                            @case ('select') {
                              <select
                                [id]="embeddedField.name"
                                [formControlName]="embeddedField.name"
                                                                [style.pointer-events]="readOnly ? 'none' : null">
                                @if (embeddedField.placeholder) {
                                  <option value="" disabled>{{ embeddedField.placeholder }}</option>
                                }
                                <option value="">--</option>
                                @for (option of embeddedField.options; track option.value) {
                                  <option [value]="option.value">{{ option.label }}</option>
                                }
                              </select>
                            }
                            @case ('radio') {
                              <div class="df-formref-radio-group"  [style.pointer-events]="readOnly ? 'none' : null">
                                @for (option of embeddedField.options; track option.value) {
                                  <label class="df-formref-radio-option" >
                                    <input
                                      type="radio"
                                      [formControlName]="embeddedField.name"
                                      [attr.name]="embeddedField.name"
                                      [value]="option.value"
                                                                          />
                                    <span class="df-formref-radio-label" >{{ option.label }}</span>
                                  </label>
                                }
                              </div>
                            }
                            @case ('checkbox') {
                              @if (embeddedField.options && embeddedField.options.length > 0) {
                                <div class="df-formref-checkbox-group"  [style.pointer-events]="readOnly ? 'none' : null">
                                  @for (option of embeddedField.options; track option.value) {
                                    <label class="df-formref-checkbox-option" >
                                      <input
                                        type="checkbox"
                                        [attr.name]="embeddedField.name + '_' + option.value"
                                                                              />
                                      <span class="df-formref-checkbox-label" >{{ option.label }}</span>
                                    </label>
                                  }
                                </div>
                              } @else {
                                <input
                                  [id]="embeddedField.name"
                                  [formControlName]="embeddedField.name"
                                  type="checkbox"
                                                                    [style.pointer-events]="readOnly ? 'none' : null"
                                />
                              }
                            }
                          }
                        </div>
                      </div>
                    }
                  }
                } @else {
                  <!-- Render fields without sections -->
                  @for (embeddedField of getFormRefFields(field); track embeddedField.name) {
                    <div
                                            [attr.data-formref-field-name]="embeddedField.name"
                      [attr.data-formref-field-type]="embeddedField.type"
                      [attr.data-field-valid]="getFormRefFormGroup(field.name)?.get(embeddedField.name)?.valid !== false || !getFormRefFormGroup(field.name)?.get(embeddedField.name)?.touched"
                      [attr.data-field-touched]="getFormRefFormGroup(field.name)?.get(embeddedField.name)?.touched"
                      [attr.data-field-required]="embeddedField.validations && embeddedField.validations.length > 0 && embeddedField.validations[0].type === 'required'">
                      <label
                        [for]="embeddedField.name"
                        >
                        {{ embeddedField.label }}
                        @if (embeddedField.validations && embeddedField.validations.length > 0 && embeddedField.validations[0].type === 'required') {
                          <span >*</span>
                        }
                      </label>
                      <div >
                        @switch (embeddedField.type) {
                          @case ('text') {
                            <input
                              [id]="embeddedField.name"
                              [formControlName]="embeddedField.name"
                              type="text"
                              [placeholder]="embeddedField.placeholder || ''"
                                                          />
                          }
                          @case ('email') {
                            <input
                              [id]="embeddedField.name"
                              [formControlName]="embeddedField.name"
                              type="email"
                              [placeholder]="embeddedField.placeholder || ''"
                                                          />
                          }
                          @case ('number') {
                            <input
                              [id]="embeddedField.name"
                              [formControlName]="embeddedField.name"
                              type="number"
                              [placeholder]="embeddedField.placeholder || ''"
                                                          />
                          }
                          @case ('textarea') {
                            <textarea
                              [id]="embeddedField.name"
                              [formControlName]="embeddedField.name"
                              [placeholder]="embeddedField.placeholder || ''"
                                                            rows="4"
                            ></textarea>
                          }
                          @case ('date') {
                            <input
                              [id]="embeddedField.name"
                              [formControlName]="embeddedField.name"
                              type="date"
                                                          />
                          }
                          @case ('select') {
                            <select
                              [id]="embeddedField.name"
                              [formControlName]="embeddedField.name"
                                                            [style.pointer-events]="readOnly ? 'none' : null">
                              @if (embeddedField.placeholder) {
                                <option value="" disabled>{{ embeddedField.placeholder }}</option>
                              }
                              <option value="">--</option>
                              @for (option of embeddedField.options; track option.value) {
                                <option [value]="option.value">{{ option.label }}</option>
                              }
                            </select>
                          }
                          @case ('radio') {
                            <div class="df-formref-radio-group"  [style.pointer-events]="readOnly ? 'none' : null">
                              @for (option of embeddedField.options; track option.value) {
                                <label class="df-formref-radio-option" >
                                  <input
                                    type="radio"
                                    [formControlName]="embeddedField.name"
                                    [attr.name]="embeddedField.name"
                                    [value]="option.value"
                                                                      />
                                  <span class="df-formref-radio-label" >{{ option.label }}</span>
                                </label>
                              }
                            </div>
                          }
                          @case ('checkbox') {
                            @if (embeddedField.options && embeddedField.options.length > 0) {
                              <div class="df-formref-checkbox-group"  [style.pointer-events]="readOnly ? 'none' : null">
                                @for (option of embeddedField.options; track option.value) {
                                  <label class="df-formref-checkbox-option" >
                                    <input
                                      type="checkbox"
                                      [attr.name]="embeddedField.name + '_' + option.value"
                                                                          />
                                    <span class="df-formref-checkbox-label" >{{ option.label }}</span>
                                  </label>
                                }
                              </div>
                            } @else {
                              <input
                                [id]="embeddedField.name"
                                [formControlName]="embeddedField.name"
                                type="checkbox"
                                                                [style.pointer-events]="readOnly ? 'none' : null"
                              />
                            }
                          }
                        }
                      </div>
                    </div>
                  }
                }
              </div>
            } @else if (field.formrefConfig) {
              <div class="df-formref-error" >
                Form "{{ field.formrefConfig.formId }}" not found
              </div>
            }
            @if (hasFormRefError(field.name)) {
              <div
                class="df-validation-error"
                [attr.data-error-for]="field.name"
                >
                Some fields in the embedded form have errors
              </div>
            }
          }
          @case ('fileupload') {
            <div
              class="fileupload-container"
              [attr.data-fileupload-name]="field.name"
              [attr.data-fileupload-valid]="isFileUploadValid(field.name)"
              [attr.data-fileupload-uploading]="isFileUploading(field.name)"
              [attr.data-fileupload-max-reached]="isMaxFilesReached(field.name)">

              <!-- Hidden file input -->
              <input
                type="file"
                [id]="field.name"
                [attr.data-fileupload-input]="field.name"
                [accept]="getAcceptAttribute(field)"
                [multiple]="(field.fileuploadConfig?.maxFiles ?? 1) > 1"
                [disabled]="form.get(field.name)?.disabled || isMaxFilesReached(field.name)"
                (change)="onFilesSelected($event, field)"
                class="fileupload-hidden-input"
              />

              <!-- Drop zone -->
              @if (!readOnly && (field.fileuploadConfig?.allowDragDrop ?? true) && !isMaxFilesReached(field.name)) {
                <div
                  class="fileupload-dropzone"
                  [attr.data-dropzone-active]="isDragActive(field.name)"
                  (dragover)="onDragOver($event, field)"
                  (dragleave)="onDragLeave($event, field)"
                  (drop)="onDrop($event, field)"
                  (click)="triggerFileInput(field.name)">
                  <span class="fileupload-dropzone-icon">&#128206;</span>
                  <span class="fileupload-dropzone-text">
                    {{ field.fileuploadConfig?.dragDropLabel || 'Drop files here or click to select' }}
                  </span>
                </div>
              } @else if (!readOnly && !isMaxFilesReached(field.name)) {
                <!-- Button only (no drag-drop) -->
                <button
                  type="button"
                  class="fileupload-button"
                  (click)="triggerFileInput(field.name)"
                  [disabled]="form.get(field.name)?.disabled">
                  {{ field.fileuploadConfig?.uploadButtonLabel || 'Choose file' }}
                </button>
              }

              <!-- File list -->
              @if (getFileUploadStates(field.name).length > 0) {
                <ul class="fileupload-list">
                  @for (fileState of getFileUploadStates(field.name); track fileState.id) {
                    <li
                      class="fileupload-item"
                      [attr.data-status]="fileState.status"
                      [attr.data-fileupload-item-id]="fileState.id">

                      <!-- File icon -->
                      <div class="fileupload-file-icon">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.9 22 6 22H18C19.1 22 20 21.1 20 20V8L14 2Z" fill="currentColor"/>
                          <path d="M14 2V8H20" fill="currentColor" opacity="0.5"/>
                        </svg>
                        <!-- Status dot -->
                        <span class="fileupload-status-dot"></span>
                      </div>

                      <!-- File info -->
                      <div class="fileupload-file-info">
                        <span class="fileupload-item-name">{{ fileState.fileName }}</span>
                        @if (field.fileuploadConfig?.showFileSize !== false) {
                          <span class="fileupload-item-size">{{ formatFileSize(fileState.fileSize) }}</span>
                        }
                      </div>

                      <!-- Status area -->
                      <div class="fileupload-status-area">
                        @if (fileState.status === 'uploading') {
                          <div class="fileupload-progress">
                            <div class="fileupload-progress-track">
                              <div
                                class="fileupload-progress-bar"
                                [style.width.%]="fileState.progress">
                              </div>
                            </div>
                            <span class="fileupload-progress-label">Uploading...</span>
                            <span class="fileupload-progress-text">{{ fileState.progress }}%</span>
                          </div>
                        }
                        @if (fileState.status === 'completed') {
                          <span class="fileupload-status-complete">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                              <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z" fill="currentColor"/>
                            </svg>
                            Complete
                          </span>
                        }
                        @if (fileState.status === 'failed' && fileState.error) {
                          <span class="fileupload-status-error">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                              <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/>
                              <path d="M12 8v5M12 16h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            {{ fileState.error }}
                          </span>
                        }
                        @if (fileState.status === 'pending') {
                          <span class="fileupload-status-pending">Pending</span>
                        }
                        @if (fileState.status === 'cancelled') {
                          <span class="fileupload-status-cancelled">Cancelled</span>
                        }
                      </div>

                      <!-- Actions -->
                      <div class="fileupload-item-actions">
                        @if (fileState.status === 'completed' && isDownloadAvailable(field)) {
                          <button
                            type="button"
                            class="fileupload-action fileupload-action-download"
                            (click)="downloadFile(field.name, fileState.id)"
                            title="Download">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                              <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" fill="currentColor"/>
                            </svg>
                          </button>
                        }
                        @if ((fileState.status === 'failed' || fileState.status === 'cancelled') && !fileState.isValidationError) {
                          <button
                            type="button"
                            class="fileupload-action fileupload-action-retry"
                            (click)="retryUpload(field.name, fileState.id)"
                            title="Retry">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                              <path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" fill="currentColor"/>
                            </svg>
                          </button>
                        }
                        @if (fileState.status === 'pending' && (field.fileuploadConfig?.uploadTiming === 'manual')) {
                          <button
                            type="button"
                            class="fileupload-action fileupload-action-upload"
                            (click)="startUpload(field.name, fileState.id)"
                            title="Upload">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                              <path d="M9 16h6v-6h4l-7-7-7 7h4v6zm-4 2h14v2H5v-2z" fill="currentColor"/>
                            </svg>
                          </button>
                        }
                        @if (!readOnly) {
                          <button
                            type="button"
                            class="fileupload-action fileupload-action-remove"
                            (click)="removeFile(field.name, fileState.id)"
                            title="Remove">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                              <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z" fill="currentColor"/>
                            </svg>
                          </button>
                        }
                      </div>
                    </li>
                  }
                </ul>
              }

              <!-- Upload all button for manual timing -->
              @if (!readOnly && (field.fileuploadConfig?.uploadTiming === 'manual') && hasPendingUploads(field.name)) {
                <button
                  type="button"
                  class="fileupload-action fileupload-action-upload-all"
                  (click)="startAllPendingUploads(field.name)">
                  Upload all
                </button>
              }
            </div>

            @if (hasFileUploadError(field.name)) {
              <div
                [attr.data-error-for]="field.name"
                >
                {{ getFileUploadErrorMessage(field.name) }}
              </div>
            }
          }
          @case ('autocomplete') {
            <div
              class="df-autocomplete-container"
                            [attr.data-autocomplete-name]="field.name"
              [attr.data-autocomplete-open]="isAutocompleteDropdownOpen(field.name)"
              [attr.data-autocomplete-loading]="isAutocompleteLoading(field.name)"
              [attr.data-autocomplete-has-selection]="hasAutocompleteSelection(field.name)">

              <div class="df-autocomplete-input-wrapper" >
                <input
                  type="text"
                  class="df-autocomplete-input"
                  [id]="field.name"
                  [value]="getAutocompleteSearchText(field.name)"
                  (input)="onAutocompleteInput($event, field.name)"
                  (keydown)="onAutocompleteKeydown($event, field.name)"
                  (focus)="getAutocompleteOptions(field.name).length > 0 ? openAutocompleteDropdown(field.name) : null"
                  [placeholder]="field.autocompleteConfig?.placeholder || field.placeholder || 'Type to search...'"
                  [readonly]="readOnly"
                  [disabled]="form.get(field.name)?.disabled"
                                    [attr.data-input-type]="field.type"
                  autocomplete="off"
                  role="combobox"
                  [attr.aria-expanded]="isAutocompleteDropdownOpen(field.name)"
                  [attr.aria-controls]="field.name + '-listbox'"
                  aria-autocomplete="list"
                />

                @if (!readOnly && hasAutocompleteSelection(field.name)) {
                  <button
                    type="button"
                    class="df-autocomplete-clear"
                                        (click)="clearAutocompleteSelection(field.name); $event.stopPropagation()"
                    aria-label="Clear selection">
                    &times;
                  </button>
                }
              </div>

              @if (isAutocompleteDropdownOpen(field.name)) {
                <div
                  class="df-autocomplete-dropdown"
                                    [id]="field.name + '-listbox'"
                  role="listbox"
                  [attr.aria-label]="field.label">

                  @if (isAutocompleteLoading(field.name)) {
                    <div class="df-autocomplete-loading-message" >
                      {{ field.autocompleteConfig?.loadingMessage || 'Loading...' }}
                    </div>
                  }

                  @if (!isAutocompleteLoading(field.name) && getAutocompleteOptions(field.name).length === 0) {
                    <div class="df-autocomplete-no-results" >
                      {{ field.autocompleteConfig?.noResultsMessage || 'No results found' }}
                    </div>
                  }

                  @if (!isAutocompleteLoading(field.name)) {
                    @for (option of getAutocompleteOptions(field.name); track option.value; let i = $index) {
                      <div
                        class="df-autocomplete-option"
                                                [attr.data-option-value]="option.value"
                        [attr.data-option-highlighted]="i === getAutocompleteHighlightedIndex(field.name)"
                        [attr.data-option-selected]="form.get(field.name)?.value?.value === option.value"
                        role="option"
                        [attr.aria-selected]="form.get(field.name)?.value?.value === option.value"
                        (click)="selectAutocompleteOption(field.name, option)"
                        (mouseenter)="setAutocompleteHighlightedIndex(field.name, i)">
                        {{ option.label }}
                      </div>
                    }
                  }
                </div>
              }
            </div>
          }
        }

        @if (hasError(field.name)) {
          <div
            class="df-validation-error"
            [attr.data-error-for]="field.name"
            >
            {{ getErrorMessage(field.name) }}
          </div>
        }
      </div>
    </div>
    }
  </ng-template>

  <!-- Wizard Mode -->
  @if (isWizardMode) {
    <!-- Wizard Progress Bar -->
    @if (config().wizard?.showProgressBar !== false) {
      <nav
        class="df-wizard-progress"
                [attr.data-wizard-total-pages]="totalPages"
        [attr.data-wizard-current-page]="currentPage"
        role="navigation"
        aria-label="Form progress">

        <ol class="df-wizard-steps" >
          @for (page of getVisiblePages(); track page.id; let i = $index) {
            <li
              class="df-wizard-step"
                            [attr.data-step-index]="i"
              [attr.data-step-id]="page.id"
              [attr.data-step-current]="i === currentPage"
              [attr.data-step-visited]="isPageVisited(i)"
              [attr.data-step-completed]="i < currentPage"
              [attr.data-step-error]="hasPageErrors(i)"
              [attr.data-step-clickable]="i <= currentPage || config().wizard?.allowFreeNavigation">

              <button
                type="button"
                class="df-wizard-step-button"
                                (click)="goToPage(i)"
                [disabled]="!(i <= currentPage || config().wizard?.allowFreeNavigation)"
                [attr.aria-current]="i === currentPage ? 'step' : null">
                <span class="df-wizard-step-number" >{{ i + 1 }}</span>
                <span class="df-wizard-step-title" >{{ page.title }}</span>
              </button>

              @if (i < totalPages - 1) {
                <span class="df-wizard-step-connector" ></span>
              }
            </li>
          }
        </ol>

        @if (config().wizard?.showPageNumbers !== false) {
          <div class="df-wizard-page-indicator" >
            Step {{ currentPage + 1 }} of {{ totalPages }}
          </div>
        }
      </nav>
    }

    <!-- Wizard Page Container -->
    <div
      class="df-wizard-page-container"
            [attr.data-current-page]="currentPage">

      @if (getCurrentPageConfig(); as currentPageConfig) {
        <div
          class="df-wizard-page"
                    [attr.data-page-id]="currentPageConfig.id"
          [attr.data-page-index]="currentPage">

          @if (currentPageConfig.description) {
            <div class="df-wizard-page-description" >
              {{ currentPageConfig.description }}
            </div>
          }

          <!-- Ungrouped fields on first page only -->
          @if (currentPage === 0) {
            @for (group of getUngroupedFields(); track $index) {
              <div
                class="df-field-row"
                                [attr.data-inline-group]="isInlineGroup(group) ? group[0].inlineGroup : null">
                @for (field of group; track field.name) {
                  @if (isFieldVisible(field.name) && (!field.archived || isArchivedFieldVisible(field))) {
                    <ng-container *ngTemplateOutlet="fieldTemplate; context: { $implicit: field }"></ng-container>
                  }
                }
              </div>
            }
          }

          <!-- Current Page Sections -->
          @for (section of getCurrentPageSections(); track section.id) {
            @if (isSectionVisible(section.id)) {
              <section
                class="df-section"
                [id]="getSectionAnchorId(section)"
                [attr.data-section-id]="section.id"
                [attr.data-section-hidden]="false">
                <header class="df-section-header" >{{ section.title }}</header>
                @if (section.description) {
                  <div class="df-section-description" >{{ section.description }}</div>
                }
                @for (group of getFieldsForSection(section.id); track $index) {
                  <div
                    class="df-field-row"
                                        [attr.data-inline-group]="isInlineGroup(group) ? group[0].inlineGroup : null">
                    @for (field of group; track field.name) {
                      @if (isFieldVisible(field.name) && (!field.archived || isArchivedFieldVisible(field))) {
                        <ng-container *ngTemplateOutlet="fieldTemplate; context: { $implicit: field }"></ng-container>
                      }
                    }
                  </div>
                }
              </section>
            }
          }
        </div>
      }
    </div>

    <!-- Wizard Navigation Buttons -->
    <div
      class="df-wizard-navigation"
            [attr.data-is-first-page]="isFirstPage"
      [attr.data-is-last-page]="isLastPage">

      <button
        type="button"
        class="df-wizard-prev"
                (click)="prevPage()"
        [disabled]="isFirstPage">
        {{ config().wizard?.prevLabel || 'Previous' }}
      </button>

      @if (!isLastPage) {
        <button
          type="button"
          class="df-wizard-next"
                    (click)="nextPage()">
          {{ config().wizard?.nextLabel || 'Next' }}
        </button>
      } @else {
        <button
          type="submit"
          class="df-wizard-submit"
                    (click)="submitForm()">
          {{ config().wizard?.submitLabel || 'Submit' }}
        </button>
      }
    </div>
  } @else {
    <!-- Normal Mode (non-wizard) -->
    <div class="df-form-fields" >
      <!-- Ungrouped fields (not assigned to any section) -->
      @for (group of getUngroupedFields(); track $index) {
        <div
          class="df-field-row"
                    [attr.data-inline-group]="isInlineGroup(group) ? group[0].inlineGroup : null">
          @for (field of group; track field.name) {
            @if (isFieldVisible(field.name) && (!field.archived || isArchivedFieldVisible(field))) {
              <ng-container *ngTemplateOutlet="fieldTemplate; context: { $implicit: field }"></ng-container>
            }
          }
        </div>
      }

      <!-- Sectioned fields -->
      @for (section of getSections(); track section.id) {
        @if (isSectionVisible(section.id)) {
          <section
            class="df-section"
            [id]="getSectionAnchorId(section)"
            [attr.data-section-id]="section.id"
            [attr.data-section-hidden]="false">
            <header class="df-section-header" >{{ section.title }}</header>
            @if (section.description) {
              <div class="df-section-description" >{{ section.description }}</div>
            }
            @for (group of getFieldsForSection(section.id); track $index) {
              <div
                class="df-field-row"
                                [attr.data-inline-group]="isInlineGroup(group) ? group[0].inlineGroup : null">
                @for (field of group; track field.name) {
                  @if (isFieldVisible(field.name) && (!field.archived || isArchivedFieldVisible(field))) {
                    <ng-container *ngTemplateOutlet="fieldTemplate; context: { $implicit: field }"></ng-container>
                  }
                }
              </div>
            }
          </section>
        }
      }

      <!-- Fallback: if no sections defined, use original grouped fields approach -->
      @if (!hasSections() && getUngroupedFields().length === 0) {
        @for (group of getGroupedFields(); track $index) {
          <div
            class="df-field-row"
                        [attr.data-inline-group]="isInlineGroup(group) ? group[0].inlineGroup : null">
            @for (field of group; track field.name) {
              @if (isFieldVisible(field.name) && (!field.archived || isArchivedFieldVisible(field))) {
                <ng-container *ngTemplateOutlet="fieldTemplate; context: { $implicit: field }"></ng-container>
              }
            }
          </div>
        }
      }
    </div>
  }

  <!-- Content projection for custom buttons/actions -->
  <ng-content></ng-content>
</form>
}
