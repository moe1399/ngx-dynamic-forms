@if (isFormReady()) {
<form
  [formGroup]="form"
  (ngSubmit)="submitForm()"
  [attr.data-form-id]="config().id"
  [attr.data-form-valid]="isFormValidForSubmit()"
  [attr.data-form-dirty]="form.dirty"
  [attr.data-form-touched]="form.touched">

  <!-- Field template defined inside form for formControlName to work -->
  <ng-template #fieldTemplate let-field>
    <!-- Info field type - renders markdown content block -->
    @if (field.type === 'info') {
      <div
        [attr.data-field-name]="field.name"
        [attr.data-field-type]="field.type"
        data-info-block
        [ngClass]="field.cssClass">
        <div
          data-info-content
          [innerHTML]="parseMarkdown(field.content)">
        </div>
      </div>
    } @else {
      <!-- Regular field types -->
      <div
        [attr.data-field-name]="field.name"
        [attr.data-field-type]="field.type"
        [attr.data-field-valid]="!hasError(field.name)"
        [attr.data-field-touched]="form.get(field.name)?.touched"
        [attr.data-field-dirty]="form.get(field.name)?.dirty"
        [attr.data-field-disabled]="form.get(field.name)?.disabled"
        [attr.data-field-required]="isFieldRequired(field)"
        [attr.data-field-width]="field.width || 1"
        [attr.data-has-label]="!!field.label"
        [ngClass]="field.cssClass">

        @if (field.label) {
          <label
            [for]="field.name"
            [attr.data-label-for]="field.name">
            {{ field.label }}
            @if (isFieldRequired(field)) {
              <span data-required-indicator>*</span>
            }
            @if (field.description) {
              <span
                data-info-icon
                (click)="togglePopover(field.name); $event.stopPropagation()"
                [attr.data-popover-open]="activePopover === field.name"
                title="Click for more information">
                &#9432;
              </span>
              @if (activePopover === field.name) {
                <span data-popover>
                  <span data-popover-content>{{ field.description }}</span>
                  <button
                    type="button"
                    data-popover-close
                    (click)="closePopover(); $event.stopPropagation()">
                    &times;
                  </button>
                </span>
              }
            }
          </label>
        }

        <div data-input-container>
        @switch (field.type) {
          @case ('text') {
            <input
              [id]="field.name"
              [formControlName]="field.name"
              type="text"
              [placeholder]="field.placeholder || ''"
              [attr.data-input-type]="field.type"
            />
          }
          @case ('email') {
            <input
              [id]="field.name"
              [formControlName]="field.name"
              type="email"
              [placeholder]="field.placeholder || ''"
              [attr.data-input-type]="field.type"
            />
          }
          @case ('number') {
            <input
              [id]="field.name"
              [formControlName]="field.name"
              type="number"
              [placeholder]="field.placeholder || ''"
              [attr.data-input-type]="field.type"
            />
          }
          @case ('textarea') {
            <textarea
              [id]="field.name"
              [formControlName]="field.name"
              [placeholder]="field.placeholder || ''"
              [attr.data-input-type]="field.type"
              rows="4"
            ></textarea>
          }
          @case ('date') {
            <input
              [id]="field.name"
              [formControlName]="field.name"
              type="date"
              [attr.data-input-type]="field.type"
            />
          }
          @case ('select') {
            <select
              [id]="field.name"
              [formControlName]="field.name"
              [attr.data-input-type]="field.type">
              @if (field.placeholder) {
                <option value="" disabled>{{ field.placeholder }}</option>
              }
              @for (option of field.options; track option.value) {
                <option [value]="option.value">{{ option.label }}</option>
              }
            </select>
          }
          @case ('radio') {
            <div
              data-radio-group
              role="radiogroup"
              [attr.aria-labelledby]="field.name + '-label'">
              @for (option of field.options; track option.value) {
                <label
                  data-radio-option
                  [attr.data-option-value]="option.value">
                  <input
                    type="radio"
                    [formControlName]="field.name"
                    [value]="option.value"
                    data-radio-input
                  />
                  <span data-radio-label>{{ option.label }}</span>
                </label>
              }
            </div>
          }
          @case ('checkbox') {
            @if (field.options && field.options.length > 0) {
              <div
                data-checkbox-group
                role="group"
                [attr.aria-labelledby]="field.name + '-label'">
                @for (option of field.options; track option.value) {
                  <label
                    data-checkbox-option
                    [attr.data-option-value]="option.value"
                    [attr.data-option-selected]="isCheckboxOptionSelected(field.name, option.value)">
                    <input
                      type="checkbox"
                      [checked]="isCheckboxOptionSelected(field.name, option.value)"
                      (change)="toggleCheckboxOption(field.name, option.value)"
                      data-checkbox-input
                    />
                    <span data-checkbox-label [innerHTML]="parseMarkdown(option.label)"></span>
                  </label>
                }
              </div>
            } @else {
              <input
                [id]="field.name"
                [formControlName]="field.name"
                type="checkbox"
                data-checkbox-single
              />
            }
          }
          @case ('table') {
            @if (field.tableConfig) {
              <div
                data-table-container
                [attr.data-table-name]="field.name"
                [attr.data-row-mode]="field.tableConfig.rowMode"
                [attr.data-table-valid]="isTableValid(field.name)">

                <table data-table [attr.data-table-for]="field.name">
                  <thead data-table-header>
                    <tr data-table-header-row>
                      @for (column of field.tableConfig.columns; track column.name) {
                        <th
                          data-table-header-cell
                          [attr.data-column-name]="column.name"
                          [attr.data-column-type]="column.type"
                          [attr.data-column-width]="column.width || 1">
                          {{ column.label }}
                          @if (hasColumnRequiredValidation(column)) {
                            <span data-required-indicator>*</span>
                          }
                        </th>
                      }
                      @if (field.tableConfig.rowMode === 'dynamic') {
                        <th data-table-header-cell data-table-actions-column></th>
                      }
                    </tr>
                  </thead>

                  <tbody data-table-body [formArrayName]="field.name">
                    @for (rowControl of getTableFormArray(field.name)?.controls; track $index; let rowIndex = $index) {
                      <tr
                        data-table-row
                        [formGroupName]="rowIndex"
                        [attr.data-row-index]="rowIndex"
                        [attr.data-row-empty]="isTableRowEmpty(field.name, rowIndex)">

                        @for (column of field.tableConfig.columns; track column.name) {
                          <td
                            data-table-cell
                            [attr.data-column-name]="column.name"
                            [attr.data-column-label]="column.label"
                            [attr.data-cell-valid]="!hasTableCellError(field.name, rowIndex, column.name)"
                            [attr.data-cell-row]="rowIndex"
                            (mouseenter)="hasTableCellError(field.name, rowIndex, column.name) ? showCellTooltip(field.name, rowIndex, column.name) : null"
                            (mouseleave)="hideCellTooltip()"
                            (focusin)="hasTableCellError(field.name, rowIndex, column.name) ? showCellTooltip(field.name, rowIndex, column.name) : null"
                            (focusout)="hideCellTooltip()">

                            @switch (column.type) {
                              @case ('text') {
                                <input
                                  type="text"
                                  [formControlName]="column.name"
                                  [placeholder]="column.placeholder || ''"
                                  data-table-input
                                  [attr.data-input-type]="column.type"
                                />
                              }
                              @case ('number') {
                                <input
                                  type="number"
                                  [formControlName]="column.name"
                                  [placeholder]="column.placeholder || ''"
                                  data-table-input
                                  [attr.data-input-type]="column.type"
                                />
                              }
                              @case ('date') {
                                <input
                                  type="date"
                                  [formControlName]="column.name"
                                  data-table-input
                                  [attr.data-input-type]="column.type"
                                />
                              }
                              @case ('select') {
                                <select
                                  [formControlName]="column.name"
                                  data-table-input
                                  [attr.data-input-type]="column.type">
                                  @if (column.placeholder) {
                                    <option value="" disabled>{{ column.placeholder }}</option>
                                  }
                                  <option value="">--</option>
                                  @for (option of column.options; track option.value) {
                                    <option [value]="option.value">{{ option.label }}</option>
                                  }
                                </select>
                              }
                            }

                            @if (hasTableCellError(field.name, rowIndex, column.name) && isCellTooltipActive(field.name, rowIndex, column.name)) {
                              <div data-cell-error-tooltip>
                                {{ getTableCellErrorMessage(field, rowIndex, column.name) }}
                              </div>
                            }
                          </td>
                        }

                        @if (field.tableConfig.rowMode === 'dynamic') {
                          <td data-table-cell data-table-actions-cell>
                            <button
                              type="button"
                              data-table-action="remove"
                              [disabled]="!canRemoveTableRow(field)"
                              (click)="removeTableRow(field, rowIndex)"
                              [attr.aria-label]="field.tableConfig.removeRowLabel || 'Remove row'">
                              &times;
                            </button>
                          </td>
                        }
                      </tr>
                    }
                  </tbody>
                </table>

                @if (field.tableConfig.rowMode === 'dynamic') {
                  <div data-table-footer>
                    <button
                      type="button"
                      data-table-action="add"
                      [disabled]="!canAddTableRow(field)"
                      (click)="addTableRow(field)">
                      {{ field.tableConfig.addRowLabel || 'Add row' }}
                    </button>
                  </div>
                }
              </div>
            }
          }
          @case ('phone') {
            @if (field.phoneConfig) {
              <div
                data-phone-container
                [formGroupName]="field.name"
                [attr.data-phone-valid]="isPhoneValid(field.name)">
                <select
                  formControlName="countryCode"
                  data-phone-country-code
                  [attr.data-input-type]="'phone-country'">
                  @for (country of field.phoneConfig.countryCodes; track country.code) {
                    <option [value]="country.code">
                      @if (country.flag) {
                        {{ country.flag }}
                      }
                      {{ country.code }} ({{ country.country }})
                    </option>
                  }
                </select>
                <input
                  type="tel"
                  formControlName="number"
                  [placeholder]="field.placeholder || 'Phone number'"
                  data-phone-number
                  [attr.data-input-type]="'phone-number'"
                  (input)="onPhoneNumberInput($event, field.name)"
                  inputmode="numeric"
                  pattern="[0-9]*"
                />
              </div>
            }
            @if (hasPhoneError(field.name)) {
              <div
                [attr.data-error-for]="field.name"
                data-validation-error>
                {{ getPhoneErrorMessage(field.name) }}
              </div>
            }
          }
          @case ('datagrid') {
            @if (field.datagridConfig) {
              <div
                data-datagrid-container
                [attr.data-datagrid-name]="field.name"
                [attr.data-datagrid-valid]="isDataGridValid(field.name)"
                [attr.data-has-column-groups]="hasDataGridColumnGroups(field)"
                [attr.data-has-row-totals]="hasDataGridRowTotals(field)"
                [attr.data-has-column-totals]="hasDataGridColumnTotals(field)">

                <table data-datagrid [attr.data-datagrid-for]="field.name">
                  <!-- Column width definitions with explicit equal widths -->
                  <colgroup>
                    <col data-col-row-label style="width: 80px" />
                    @for (column of field.datagridConfig.columns; track column.name) {
                      <col data-col-data [style.width]="getDataGridDataColumnWidth(field)" />
                    }
                    @if (hasDataGridRowTotals(field)) {
                      <col data-col-total style="width: 80px" />
                    }
                  </colgroup>

                  <!-- Two-tier header: Column Groups -->
                  @if (hasDataGridColumnGroups(field)) {
                    <thead data-datagrid-header data-datagrid-header-groups>
                      <!-- First row: Group headers and ungrouped columns in column order -->
                      <tr data-datagrid-group-row>
                        <!-- Row label column header (spans both rows) -->
                        <th
                          data-datagrid-header-cell
                          data-row-label-header
                          rowspan="2">
                          {{ field.datagridConfig.rowLabelHeader || '' }}
                        </th>

                        <!-- Headers in column order -->
                        @for (item of getDataGridOrderedHeaderItems(field); track item.type === 'group' ? item.group.id : item.column.name) {
                          @if (item.type === 'group') {
                            <th
                              data-datagrid-header-cell
                              data-column-group
                              [attr.data-column-group-id]="item.group.id"
                              [attr.data-column-group-label]="item.group.label"
                              [attr.colspan]="item.group.columnIds.length">
                              {{ item.group.label }}
                            </th>
                          } @else {
                            <th
                              data-datagrid-header-cell
                              data-column-ungrouped
                              [attr.data-column-name]="item.column.name"
                              [attr.data-column-type]="item.column.type"
                              [attr.data-column-computed]="item.column.computed || false"
                              [attr.data-column-width]="item.column.width || 1"
                              rowspan="2">
                              {{ item.column.label }}
                              @if (!item.column.computed && hasDataGridColumnRequiredValidation(item.column)) {
                                <span data-required-indicator>*</span>
                              }
                            </th>
                          }
                        }

                        <!-- Row total header (spans both rows) -->
                        @if (hasDataGridRowTotals(field)) {
                          <th
                            data-datagrid-header-cell
                            data-row-total-header
                            rowspan="2">
                            {{ field.datagridConfig.totals?.rowTotalLabel || 'Total' }}
                          </th>
                        }
                      </tr>

                      <!-- Second row: Individual columns within groups (in column order) -->
                      <tr data-datagrid-column-row>
                        @for (item of getDataGridOrderedHeaderItems(field); track item.type === 'group' ? item.group.id : item.column.name) {
                          @if (item.type === 'group') {
                            @for (columnName of item.group.columnIds; track columnName) {
                              <th
                                data-datagrid-header-cell
                                [attr.data-column-name]="columnName"
                                [attr.data-column-type]="getDataGridColumn(field, columnName)?.type"
                                [attr.data-column-computed]="getDataGridColumn(field, columnName)?.computed || false"
                                [attr.data-column-width]="getDataGridColumn(field, columnName)?.width || 1"
                                [attr.data-in-group]="item.group.id">
                                {{ getDataGridColumn(field, columnName)?.label }}
                                @if (!getDataGridColumn(field, columnName)?.computed && hasDataGridColumnRequiredValidation(getDataGridColumn(field, columnName)!)) {
                                  <span data-required-indicator>*</span>
                                }
                              </th>
                            }
                          }
                        }
                      </tr>
                    </thead>
                  } @else {
                    <!-- Single-tier header (no groups) -->
                    <thead data-datagrid-header>
                      <tr data-datagrid-header-row>
                        <th data-datagrid-header-cell data-row-label-header>
                          {{ field.datagridConfig.rowLabelHeader || '' }}
                        </th>
                        @for (column of field.datagridConfig.columns; track column.name) {
                          <th
                            data-datagrid-header-cell
                            [attr.data-column-name]="column.name"
                            [attr.data-column-type]="column.type"
                            [attr.data-column-computed]="column.computed || false"
                            [attr.data-column-width]="column.width || 1">
                            {{ column.label }}
                            @if (!column.computed && hasDataGridColumnRequiredValidation(column)) {
                              <span data-required-indicator>*</span>
                            }
                          </th>
                        }
                        @if (hasDataGridRowTotals(field)) {
                          <th data-datagrid-header-cell data-row-total-header>
                            {{ field.datagridConfig.totals?.rowTotalLabel || 'Total' }}
                          </th>
                        }
                      </tr>
                    </thead>
                  }

                  <!-- Data rows -->
                  <tbody data-datagrid-body [formGroupName]="field.name">
                    @for (rowLabel of field.datagridConfig.rowLabels; track rowLabel.id) {
                      <tr
                        data-datagrid-row
                        [formGroupName]="rowLabel.id"
                        [attr.data-row-id]="rowLabel.id"
                        [attr.data-row-label]="rowLabel.label">

                        <!-- Row label cell -->
                        <td
                          data-datagrid-cell
                          data-row-label-cell
                          [attr.data-row-label-header]="field.datagridConfig.rowLabelHeader || ''">
                          {{ rowLabel.label }}
                        </td>

                        <!-- Data cells -->
                        @for (column of field.datagridConfig.columns; track column.name) {
                          <td
                            data-datagrid-cell
                            [attr.data-column-name]="column.name"
                            [attr.data-column-label]="column.label"
                            [attr.data-column-group-label]="getDataGridColumnGroupLabel(field, column.name) || null"
                            [attr.data-column-type]="column.type"
                            [attr.data-column-computed]="column.computed || false"
                            [attr.data-cell-valid]="column.computed || !hasDataGridCellError(field.name, rowLabel.id, column.name)">

                            @if (column.computed) {
                              <!-- Computed cell (read-only) -->
                              <span data-datagrid-computed-value>
                                {{ getDataGridComputedValue(field, rowLabel.id, column) }}
                              </span>
                            } @else {
                              <!-- Editable cell -->
                              @switch (column.type) {
                                @case ('text') {
                                  <input
                                    type="text"
                                    [formControlName]="column.name"
                                    [placeholder]="column.placeholder || ''"
                                    data-datagrid-input
                                    [attr.data-input-type]="column.type"
                                  />
                                }
                                @case ('number') {
                                  <input
                                    type="number"
                                    [formControlName]="column.name"
                                    [placeholder]="column.placeholder || ''"
                                    data-datagrid-input
                                    [attr.data-input-type]="column.type"
                                  />
                                }
                                @case ('date') {
                                  <input
                                    type="date"
                                    [formControlName]="column.name"
                                    data-datagrid-input
                                    [attr.data-input-type]="column.type"
                                  />
                                }
                                @case ('select') {
                                  <select
                                    [formControlName]="column.name"
                                    data-datagrid-input
                                    [attr.data-input-type]="column.type">
                                    <option value="">--</option>
                                    @for (option of column.options; track option.value) {
                                      <option [value]="option.value">{{ option.label }}</option>
                                    }
                                  </select>
                                }
                              }
                            }
                          </td>
                        }

                        <!-- Row total cell -->
                        @if (hasDataGridRowTotals(field)) {
                          <td
                            data-datagrid-cell
                            data-row-total-cell
                            data-is-total-column="true"
                            [attr.data-total-label]="field.datagridConfig.totals?.rowTotalLabel || 'Total'">
                            <span data-datagrid-computed-value>
                              {{ getDataGridRowTotal(field, rowLabel.id) }}
                            </span>
                          </td>
                        }
                      </tr>
                    }

                    <!-- Column totals row -->
                    @if (hasDataGridColumnTotals(field)) {
                      <tr data-datagrid-row data-is-total-row="true">
                        <td data-datagrid-cell data-row-label-cell data-total-label-cell>
                          {{ field.datagridConfig.totals?.columnTotalLabel || 'Total' }}
                        </td>
                        @for (column of field.datagridConfig.columns; track column.name) {
                          <td
                            data-datagrid-cell
                            data-column-total-cell
                            [attr.data-column-name]="column.name"
                            [attr.data-column-label]="column.label"
                            data-is-total-row="true">
                            <span data-datagrid-computed-value>
                              {{ getDataGridColumnTotal(field, column.name) }}
                            </span>
                          </td>
                        }
                        @if (hasDataGridRowTotals(field)) {
                          <td data-datagrid-cell data-grand-total-cell data-is-total-row="true" data-is-total-column="true">
                            <span data-datagrid-computed-value>
                              {{ getDataGridGrandTotal(field) }}
                            </span>
                          </td>
                        }
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            }
          }
        }

        @if (hasError(field.name)) {
          <div
            [attr.data-error-for]="field.name"
            data-validation-error>
            {{ getErrorMessage(field.name) }}
          </div>
        }
      </div>
    </div>
    }
  </ng-template>

  <div data-form-section="fields">
    <!-- Ungrouped fields (not assigned to any section) -->
    @for (group of getUngroupedFields(); track $index) {
      <div
        data-field-row
        [attr.data-inline-group]="isInlineGroup(group) ? group[0].inlineGroup : null">
        @for (field of group; track field.name) {
          <ng-container *ngTemplateOutlet="fieldTemplate; context: { $implicit: field }"></ng-container>
        }
      </div>
    }

    <!-- Sectioned fields -->
    @for (section of getSections(); track section.id) {
      <section
        [id]="getSectionAnchorId(section)"
        [attr.data-section-id]="section.id">
        <header data-section-header>{{ section.title }}</header>
        @if (section.description) {
          <div data-section-description>{{ section.description }}</div>
        }
        @for (group of getFieldsForSection(section.id); track $index) {
          <div
            data-field-row
            [attr.data-inline-group]="isInlineGroup(group) ? group[0].inlineGroup : null">
            @for (field of group; track field.name) {
              <ng-container *ngTemplateOutlet="fieldTemplate; context: { $implicit: field }"></ng-container>
            }
          </div>
        }
      </section>
    }

    <!-- Fallback: if no sections defined, use original grouped fields approach -->
    @if (!hasSections() && getUngroupedFields().length === 0) {
      @for (group of getGroupedFields(); track $index) {
        <div
          data-field-row
          [attr.data-inline-group]="isInlineGroup(group) ? group[0].inlineGroup : null">
          @for (field of group; track field.name) {
            <ng-container *ngTemplateOutlet="fieldTemplate; context: { $implicit: field }"></ng-container>
          }
        </div>
      }
    }
  </div>

  <div data-form-section="actions">
    @if (config().saveLabel) {
      <button
        type="button"
        data-action="save"
        (click)="saveForm()">
        {{ config().saveLabel }}
      </button>
    }
    <button
      type="submit"
      data-action="submit"
      [attr.data-can-submit]="isFormValidForSubmit()">
      {{ config().submitLabel || 'Submit' }}
    </button>
  </div>
</form>
}
