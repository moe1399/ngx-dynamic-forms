@if (isFormReady()) {
<form
  [formGroup]="form"
  (ngSubmit)="submitForm()"
  [attr.data-form-id]="config().id"
  [attr.data-form-valid]="form.valid"
  [attr.data-form-dirty]="form.dirty"
  [attr.data-form-touched]="form.touched">

  <!-- Field template defined inside form for formControlName to work -->
  <ng-template #fieldTemplate let-field>
    <div
      [attr.data-field-name]="field.name"
      [attr.data-field-type]="field.type"
      [attr.data-field-valid]="!hasError(field.name)"
      [attr.data-field-touched]="form.get(field.name)?.touched"
      [attr.data-field-dirty]="form.get(field.name)?.dirty"
      [attr.data-field-disabled]="form.get(field.name)?.disabled"
      [attr.data-field-required]="isFieldRequired(field)"
      [attr.data-field-width]="field.width || 1"
      [ngClass]="field.cssClass">

      <label
        [for]="field.name"
        [attr.data-label-for]="field.name">
        {{ field.label }}
        @if (isFieldRequired(field)) {
          <span data-required-indicator>*</span>
        }
        @if (field.description) {
          <span
            data-info-icon
            (click)="togglePopover(field.name); $event.stopPropagation()"
            [attr.data-popover-open]="activePopover === field.name"
            title="Click for more information">
            &#9432;
          </span>
          @if (activePopover === field.name) {
            <span data-popover>
              <span data-popover-content>{{ field.description }}</span>
              <button
                type="button"
                data-popover-close
                (click)="closePopover(); $event.stopPropagation()">
                &times;
              </button>
            </span>
          }
        }
      </label>

      <div data-input-container>
        @switch (field.type) {
          @case ('text') {
            <input
              [id]="field.name"
              [formControlName]="field.name"
              type="text"
              [placeholder]="field.placeholder || ''"
              [attr.data-input-type]="field.type"
            />
          }
          @case ('email') {
            <input
              [id]="field.name"
              [formControlName]="field.name"
              type="email"
              [placeholder]="field.placeholder || ''"
              [attr.data-input-type]="field.type"
            />
          }
          @case ('number') {
            <input
              [id]="field.name"
              [formControlName]="field.name"
              type="number"
              [placeholder]="field.placeholder || ''"
              [attr.data-input-type]="field.type"
            />
          }
          @case ('textarea') {
            <textarea
              [id]="field.name"
              [formControlName]="field.name"
              [placeholder]="field.placeholder || ''"
              [attr.data-input-type]="field.type"
              rows="4"
            ></textarea>
          }
          @case ('date') {
            <input
              [id]="field.name"
              [formControlName]="field.name"
              type="date"
              [attr.data-input-type]="field.type"
            />
          }
          @case ('select') {
            <select
              [id]="field.name"
              [formControlName]="field.name"
              [attr.data-input-type]="field.type">
              @if (field.placeholder) {
                <option value="" disabled>{{ field.placeholder }}</option>
              }
              @for (option of field.options; track option.value) {
                <option [value]="option.value">{{ option.label }}</option>
              }
            </select>
          }
          @case ('radio') {
            <div
              data-radio-group
              role="radiogroup"
              [attr.aria-labelledby]="field.name + '-label'">
              @for (option of field.options; track option.value) {
                <label
                  data-radio-option
                  [attr.data-option-value]="option.value">
                  <input
                    type="radio"
                    [formControlName]="field.name"
                    [value]="option.value"
                    data-radio-input
                  />
                  <span data-radio-label>{{ option.label }}</span>
                </label>
              }
            </div>
          }
          @case ('checkbox') {
            @if (field.options && field.options.length > 0) {
              <div
                data-checkbox-group
                role="group"
                [attr.aria-labelledby]="field.name + '-label'">
                @for (option of field.options; track option.value) {
                  <label
                    data-checkbox-option
                    [attr.data-option-value]="option.value"
                    [attr.data-option-selected]="isCheckboxOptionSelected(field.name, option.value)">
                    <input
                      type="checkbox"
                      [checked]="isCheckboxOptionSelected(field.name, option.value)"
                      (change)="toggleCheckboxOption(field.name, option.value)"
                      data-checkbox-input
                    />
                    <span data-checkbox-label>{{ option.label }}</span>
                  </label>
                }
              </div>
            } @else {
              <input
                [id]="field.name"
                [formControlName]="field.name"
                type="checkbox"
                data-checkbox-single
              />
            }
          }
        }

        @if (hasError(field.name)) {
          <div
            [attr.data-error-for]="field.name"
            data-validation-error>
            {{ getErrorMessage(field.name) }}
          </div>
        }
      </div>
    </div>
  </ng-template>

  <div data-form-section="fields">
    <!-- Ungrouped fields (not assigned to any section) -->
    @for (group of getUngroupedFields(); track $index) {
      <div
        data-field-row
        [attr.data-inline-group]="isInlineGroup(group) ? group[0].inlineGroup : null">
        @for (field of group; track field.name) {
          <ng-container *ngTemplateOutlet="fieldTemplate; context: { $implicit: field }"></ng-container>
        }
      </div>
    }

    <!-- Sectioned fields -->
    @for (section of getSections(); track section.id) {
      <section
        [id]="getSectionAnchorId(section)"
        [attr.data-section-id]="section.id">
        <header data-section-header>{{ section.title }}</header>
        @if (section.description) {
          <div data-section-description>{{ section.description }}</div>
        }
        @for (group of getFieldsForSection(section.id); track $index) {
          <div
            data-field-row
            [attr.data-inline-group]="isInlineGroup(group) ? group[0].inlineGroup : null">
            @for (field of group; track field.name) {
              <ng-container *ngTemplateOutlet="fieldTemplate; context: { $implicit: field }"></ng-container>
            }
          </div>
        }
      </section>
    }

    <!-- Fallback: if no sections defined, use original grouped fields approach -->
    @if (!hasSections() && getUngroupedFields().length === 0) {
      @for (group of getGroupedFields(); track $index) {
        <div
          data-field-row
          [attr.data-inline-group]="isInlineGroup(group) ? group[0].inlineGroup : null">
          @for (field of group; track field.name) {
            <ng-container *ngTemplateOutlet="fieldTemplate; context: { $implicit: field }"></ng-container>
          }
        </div>
      }
    }
  </div>

  <div data-form-section="actions">
    @if (config().saveLabel) {
      <button
        type="button"
        data-action="save"
        (click)="saveForm()">
        {{ config().saveLabel }}
      </button>
    }
    <button
      type="submit"
      data-action="submit"
      [attr.data-can-submit]="form.valid">
      {{ config().submitLabel || 'Submit' }}
    </button>
  </div>
</form>
}
